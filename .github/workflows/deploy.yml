name: Deploy to K3s (production)

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      K3S_SERVER_IP: ${{ secrets.K3S_SERVER_IP }}
      K3S_SSH_USER: ${{ secrets.K3S_SSH_USER }}
      K3S_SSH_KEY_BASE64: ${{ secrets.K3S_SSH_KEY_BASE64 }}
      KUBE_NAMESPACE: booking
      # –ë–∞–∑–æ–≤—ã–π –∞–¥—Ä–µ—Å Docker registry (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é GitLab Container Registry)
      CI_REGISTRY: ${{ secrets.CI_REGISTRY || 'registry.gitlab.com' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-client netcat-openbsd curl
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º kubectl
          KUBECTL_VERSION=$(curl -L -s https://dl.k8s.io/release/stable.txt)
          echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ kubectl –≤–µ—Ä—Å–∏–∏: $KUBECTL_VERSION"
          curl -LO "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
          kubectl version --client
          rm -f kubectl

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: fastapi/requirements.txt

      - name: Run linting and unit tests
        run: |
          echo "=========================================="
          echo "=== TESTS: –õ–∏–Ω—Ç–µ—Ä—ã + unit —Ç–µ—Å—Ç—ã ==="
          echo "=========================================="
          echo ""
          cd fastapi
          
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ Python..."
          python --version
          
          echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
          python -m venv venv
          source venv/bin/activate
          
          echo "üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          pip install --upgrade pip
          pip install -r requirements.txt || {
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π!"
            exit 1
          }
          
          echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
          
          echo ""
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–ª—é—á–µ–≤—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          python -c "import redis; print(f'‚úÖ redis –≤–µ—Ä—Å–∏—è: {redis.__version__}')" || {
            echo "‚ùå –ú–æ–¥—É–ª—å redis –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
            exit 1
          }
          python -c "import pytest; print(f'‚úÖ pytest –≤–µ—Ä—Å–∏—è: {pytest.__version__}')" || {
            echo "‚ùå –ú–æ–¥—É–ª—å pytest –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
            exit 1
          }
          python -c "import ruff; print('‚úÖ ruff —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω')" || {
            echo "‚ùå –ú–æ–¥—É–ª—å ruff –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
            exit 1
          }
          python -c "import pyright; print('‚úÖ pyright —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω')" || {
            echo "‚ùå –ú–æ–¥—É–ª—å pyright –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
            exit 1
          }
          
          echo ""
          echo "=========================================="
          echo "=== LINT: –ó–∞–ø—É—Å–∫ ruff ==="
          echo "=========================================="
          echo ""
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ —Å –ø–æ–º–æ—â—å—é ruff..."
          ruff check src/ tests/ || {
            echo "‚ùå Ruff –Ω–∞—à–µ–ª –æ—à–∏–±–∫–∏!"
            exit 1
          }
          echo "‚úÖ Ruff –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!"
          
          echo ""
          echo "=========================================="
          echo "=== TYPE CHECK: –ó–∞–ø—É—Å–∫ pyright ==="
          echo "=========================================="
          echo ""
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ —Å –ø–æ–º–æ—â—å—é pyright..."
          pyright src/ || {
            echo "‚ùå Pyright –Ω–∞—à–µ–ª –æ—à–∏–±–∫–∏ —Ç–∏–ø–æ–≤!"
            exit 1
          }
          echo "‚úÖ Pyright –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!"
          
          echo ""
          echo "=========================================="
          echo "=== TESTS: –ó–∞–ø—É—Å–∫ unit —Ç–µ—Å—Ç–æ–≤ ==="
          echo "=========================================="
          echo ""
          echo "üß™ –ó–∞–ø—É—Å–∫ unit —Ç–µ—Å—Ç–æ–≤..."
          pytest tests/unit_tests/ -v --tb=short --color=yes || {
            echo "‚ùå Unit —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏!"
            exit 1
          }
          
          echo ""
          echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!"

      - name: Login to Container Registry and build/push images
        env:
          CI_REGISTRY_IMAGE: ${{ secrets.CI_REGISTRY_IMAGE || 'registry.gitlab.com/shum-bookin/shum-booking' }}
          CI_REGISTRY: ${{ env.CI_REGISTRY }}
          CI_REGISTRY_USER: ${{ secrets.CI_REGISTRY_USER }}
          CI_REGISTRY_PASSWORD: ${{ secrets.CI_REGISTRY_PASSWORD }}
          CI_COMMIT_SHA: ${{ github.sha }}
        run: |
          echo "=========================================="
          echo "=== BUILD: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö registry ==="
          echo "=========================================="
          echo ""
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è —Å–±–æ—Ä–∫–∏ –æ–±—Ä–∞–∑–æ–≤..."
          
          if [ -z "$CI_REGISTRY_USER" ] || [ -z "$CI_REGISTRY_PASSWORD" ]; then
            echo "‚ùå CI_REGISTRY_USER –∏–ª–∏ CI_REGISTRY_PASSWORD –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ GitHub Secrets ‚Äì –Ω–µ –º–æ–∂–µ–º –∑–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –≤ —Ä–µ–µ—Å—Ç—Ä"
            exit 1
          fi
          
          echo "‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ registry —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:"
          echo "  CI_REGISTRY: $CI_REGISTRY"
          echo "  CI_REGISTRY_USER: $CI_REGISTRY_USER"
          echo "  CI_REGISTRY_PASSWORD: [–°–ö–†–´–¢–û]"
          echo "  CI_REGISTRY_IMAGE: $CI_REGISTRY_IMAGE"
          echo "  CI_COMMIT_SHA: $CI_COMMIT_SHA"
          
          echo ""
          echo "=== LOGIN: Docker registry $CI_REGISTRY ==="
          echo "$CI_REGISTRY_PASSWORD" | docker login "$CI_REGISTRY" -u "$CI_REGISTRY_USER" --password-stdin

          echo "=== BUILD: FastAPI –æ–±—Ä–∞–∑ (docker build & push) ==="
          cd fastapi
          docker build \
            -f Dockerfile.prod \
            -t "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA" \
            -t "$CI_REGISTRY_IMAGE:latest" \
            .
          docker push "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA"
          docker push "$CI_REGISTRY_IMAGE:latest"

          echo "=== BUILD: Nginx –æ–±—Ä–∞–∑ (docker build & push) ==="
          cd ../nginx
          docker build \
            -f Dockerfile \
            -t "$CI_REGISTRY_IMAGE/nginx:$CI_COMMIT_SHA" \
            -t "$CI_REGISTRY_IMAGE/nginx:latest" \
            .
          docker push "$CI_REGISTRY_IMAGE/nginx:$CI_COMMIT_SHA"
          docker push "$CI_REGISTRY_IMAGE/nginx:latest"

          echo "‚úÖ –û–±—Ä–∞–∑—ã FastAPI –∏ Nginx —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ —Ä–µ–µ—Å—Ç—Ä"

      - name: Prepare SSH key
        run: |
          echo "=========================================="
          echo "=== SSH: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ==="
          echo "=========================================="
          echo ""
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö SSH..."
          
          if [ -z "$K3S_SSH_KEY_BASE64" ] || [ -z "$K3S_SERVER_IP" ] || [ -z "$K3S_SSH_USER" ]; then
            echo "‚ùå K3S_SSH_KEY_BASE64, K3S_SERVER_IP –∏–ª–∏ K3S_SSH_USER –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ GitHub Secrets!"
            exit 1
          fi
          
          echo "‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ SSH —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:"
          echo "  K3S_SERVER_IP: $K3S_SERVER_IP"
          echo "  K3S_SSH_USER: $K3S_SSH_USER"
          echo "  K3S_SSH_KEY_BASE64: [–°–ö–†–´–¢–û]"
          
          echo ""
          echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –∫–ª—é—á–∞..."
          mkdir -p ~/.ssh
          echo "$K3S_SSH_KEY_BASE64" | base64 -d > ~/.ssh/k3s_key
          chmod 600 ~/.ssh/k3s_key
          ssh-keyscan -H "$K3S_SERVER_IP" >> ~/.ssh/known_hosts 2>/dev/null || true
          echo "‚úÖ SSH key and known_hosts configured"

      - name: Export CI vars and check ACTIVE_CI_PROVIDER
        run: |
          echo "=========================================="
          echo "=== CI: –≠–∫—Å–ø–æ—Ä—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è ==="
          echo "=========================================="
          echo ""
          echo "üîß –≠–∫—Å–ø–æ—Ä—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è –¥–µ–ø–ª–æ—è..."
          
          export K3S_SSH_KEY_PATH="$HOME/.ssh/k3s_key"
          export K3S_SSH_USER
          export K3S_SERVER_IP
          export K3S_SSH_HOST="$K3S_SSH_USER@$K3S_SERVER_IP"
          export KUBE_CONFIG_PATH="$HOME/.kube/config"
          
          echo "‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:"
          echo "  K3S_SSH_KEY_PATH: $K3S_SSH_KEY_PATH"
          echo "  K3S_SSH_USER: $K3S_SSH_USER"
          echo "  K3S_SERVER_IP: $K3S_SERVER_IP"
          echo "  K3S_SSH_HOST: $K3S_SSH_HOST"
          echo "  KUBE_CONFIG_PATH: $KUBE_CONFIG_PATH"
          
          echo ""
          echo "üîß –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–∫—Ä–∏–ø—Ç–æ–≤..."
          chmod +x ci/gitlab/*.sh ci/common/*.sh || true
          
          echo ""
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ ACTIVE_CI_PROVIDER..."
          export ACTIVE_CI_PROVIDER_EXPECTED=github
          echo "  –û–∂–∏–¥–∞–µ–º—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä: $ACTIVE_CI_PROVIDER_EXPECTED"
          ci/common/check-active-provider.sh || { echo "‚ö†Ô∏è ACTIVE_CI_PROVIDER –Ω–µ github, –¥–µ–ø–ª–æ–π –∏–∑ GitHub –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"; exit 0; }
          echo "‚úÖ ACTIVE_CI_PROVIDER –ø—Ä–æ–≤–µ—Ä–µ–Ω"

      - name: Get kubeconfig from server
        run: |
          echo "=========================================="
          echo "=== KUBECONFIG: –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ==="
          echo "=========================================="
          echo ""
          ci/gitlab/get-kubeconfig.sh
          echo ""
          echo "‚úÖ Kubeconfig –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é"

      - name: Deploy manifests (reuse GitLab scripts)
        env:
          CI_REGISTRY_IMAGE: ${{ secrets.CI_REGISTRY_IMAGE }}
          CI_COMMIT_SHA: ${{ github.sha }}
          CI_REGISTRY: ${{ secrets.CI_REGISTRY }}
          CI_REGISTRY_USER: ${{ secrets.CI_REGISTRY_USER }}
          CI_REGISTRY_PASSWORD: ${{ secrets.CI_REGISTRY_PASSWORD }}
        run: |
          echo "=========================================="
          echo "=== DEPLOY (GitHub): –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö ==="
          echo "=========================================="
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
          echo ""
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö..."
          : "${CI_REGISTRY:?‚ùå CI_REGISTRY is required}"
          : "${CI_REGISTRY_USER:?‚ùå CI_REGISTRY_USER is required}"
          : "${CI_REGISTRY_PASSWORD:?‚ùå CI_REGISTRY_PASSWORD is required}"
          : "${CI_REGISTRY_IMAGE:?‚ùå CI_REGISTRY_IMAGE is required}"
          : "${CI_COMMIT_SHA:?‚ùå CI_COMMIT_SHA is required}"
          
          echo "‚úÖ –í—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
          
          # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–º–µ–Ω–∏ imagePullSecret –Ω–∞ –æ—Å–Ω–æ–≤–µ registry
          echo ""
          echo "üîç –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–º–µ–Ω–∏ imagePullSecret..."
          if [[ -n "${CI_REGISTRY:-}" ]]; then
            if [[ "$CI_REGISTRY" == *"ghcr.io"* ]] || [[ "${CI_REGISTRY_IMAGE:-}" == *"ghcr.io"* ]]; then
              IMAGE_PULL_SECRET_NAME="ghcr-registry-secret"
            elif [[ "$CI_REGISTRY" == *"registry.gitlab.com"* ]] || [[ "${CI_REGISTRY_IMAGE:-}" == *"registry.gitlab.com"* ]]; then
              IMAGE_PULL_SECRET_NAME="gitlab-registry-secret"
            else
              IMAGE_PULL_SECRET_NAME="registry-secret"
            fi
          else
            # –ü—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ CI_REGISTRY_IMAGE
            if [[ "${CI_REGISTRY_IMAGE:-}" == *"ghcr.io"* ]]; then
              IMAGE_PULL_SECRET_NAME="ghcr-registry-secret"
            elif [[ "${CI_REGISTRY_IMAGE:-}" == *"registry.gitlab.com"* ]]; then
              IMAGE_PULL_SECRET_NAME="gitlab-registry-secret"
            else
              echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø registry –∏–∑ CI_REGISTRY –∏–ª–∏ CI_REGISTRY_IMAGE"
              exit 1
            fi
          fi
          
          echo "‚úÖ –ò–º—è imagePullSecret –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ: $IMAGE_PULL_SECRET_NAME"
          
          # –í—ã–≤–æ–¥ –∑–Ω–∞—á–µ–Ω–∏–π (–±–µ–∑ –ø–∞—Ä–æ–ª–µ–π)
          echo ""
          echo "üìã –ó–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:"
          echo "  CI_REGISTRY: $CI_REGISTRY"
          echo "  CI_REGISTRY_USER: $CI_REGISTRY_USER"
          echo "  CI_REGISTRY_PASSWORD: [–°–ö–†–´–¢–û]"
          echo "  CI_REGISTRY_IMAGE: $CI_REGISTRY_IMAGE"
          echo "  CI_COMMIT_SHA: $CI_COMMIT_SHA"
          echo "  IMAGE_PULL_SECRET_NAME: $IMAGE_PULL_SECRET_NAME (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ)"
          
          export CI_REGISTRY
          export CI_REGISTRY_USER
          export CI_REGISTRY_PASSWORD
          export CI_REGISTRY_IMAGE
          export CI_COMMIT_SHA
          export IMAGE_PULL_SECRET_NAME
          
          echo ""
          echo "=========================================="
          echo "=== –≠–∫—Å–ø–æ—Ä—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ ==="
          echo "=========================================="
          export FASTAPI_REPLICAS=${FASTAPI_REPLICAS:-1}
          export CELERY_REPLICAS=${CELERY_REPLICAS:-1}
          export NGINX_REPLICAS=${NGINX_REPLICAS:-1}
          export POSTGRES_REPLICAS=${POSTGRES_REPLICAS:-1}
          export REDIS_REPLICAS=${REDIS_REPLICAS:-1}
          export FASTAPI_MEMORY_REQUEST=${FASTAPI_MEMORY_REQUEST:-256Mi}
          export FASTAPI_CPU_REQUEST=${FASTAPI_CPU_REQUEST:-20m}
          export CELERY_MEMORY_REQUEST=${CELERY_MEMORY_REQUEST:-128Mi}
          export CELERY_CPU_REQUEST=${CELERY_CPU_REQUEST:-15m}
          export NGINX_MEMORY_REQUEST=${NGINX_MEMORY_REQUEST:-32Mi}
          export NGINX_CPU_REQUEST=${NGINX_CPU_REQUEST:-10m}
          export NGINX_MEMORY_LIMIT=${NGINX_MEMORY_LIMIT:-64Mi}
          export NGINX_CPU_LIMIT=${NGINX_CPU_LIMIT:-20m}
          export POSTGRES_MEMORY_REQUEST=${POSTGRES_MEMORY_REQUEST:-128Mi}
          export POSTGRES_CPU_REQUEST=${POSTGRES_CPU_REQUEST:-40m}
          export POSTGRES_MEMORY_LIMIT=${POSTGRES_MEMORY_LIMIT:-256Mi}
          export POSTGRES_CPU_LIMIT=${POSTGRES_CPU_LIMIT:-60m}
          export REDIS_MEMORY_REQUEST=${REDIS_MEMORY_REQUEST:-64Mi}
          export REDIS_CPU_REQUEST=${REDIS_CPU_REQUEST:-20m}
          export REDIS_MEMORY_LIMIT=${REDIS_MEMORY_LIMIT:-128Mi}
          export REDIS_CPU_LIMIT=${REDIS_CPU_LIMIT:-40m}
          export POSTGRES_STORAGE_SIZE=${POSTGRES_STORAGE_SIZE:-20Gi}
          export REDIS_STORAGE_SIZE=${REDIS_STORAGE_SIZE:-5Gi}
          export IMAGES_STORAGE_SIZE=${IMAGES_STORAGE_SIZE:-5Gi}
          export POSTGRES_IMAGE_TAG=${POSTGRES_IMAGE_TAG:-postgres:16}
          export REDIS_IMAGE_TAG=${REDIS_IMAGE_TAG:-redis:7-alpine}
          export DOMAIN=${DOMAIN:-async-black.ru}
          export LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL:-arsen.davydov@gmail.com}
          export LETSENCRYPT_SERVER=${LETSENCRYPT_SERVER:-production}
          export HEALTH_CHECK_INITIAL_DELAY=${HEALTH_CHECK_INITIAL_DELAY:-30}
          export HEALTH_CHECK_PERIOD=${HEALTH_CHECK_PERIOD:-10}
          export HEALTH_CHECK_TIMEOUT=${HEALTH_CHECK_TIMEOUT:-5}
          export HEALTH_CHECK_FAILURE_THRESHOLD=${HEALTH_CHECK_FAILURE_THRESHOLD:-3}
          export HEALTH_CHECK_READINESS_INITIAL_DELAY=${HEALTH_CHECK_READINESS_INITIAL_DELAY:-10}
          export HEALTH_CHECK_READINESS_PERIOD=${HEALTH_CHECK_READINESS_PERIOD:-5}
          
          echo ""
          echo "üìä –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å–æ–≤ (—Å –¥–µ—Ñ–æ–ª—Ç–∞–º–∏):"
          echo "  –†–µ–ø–ª–∏–∫–∏:"
          echo "    FASTAPI_REPLICAS=$FASTAPI_REPLICAS"
          echo "    CELERY_REPLICAS=$CELERY_REPLICAS"
          echo "    NGINX_REPLICAS=$NGINX_REPLICAS"
          echo "    POSTGRES_REPLICAS=$POSTGRES_REPLICAS"
          echo "    REDIS_REPLICAS=$REDIS_REPLICAS"
          echo "  –†–µ—Å—É—Ä—Å—ã FastAPI:"
          echo "    FASTAPI_MEMORY_REQUEST=$FASTAPI_MEMORY_REQUEST"
          echo "    FASTAPI_CPU_REQUEST=$FASTAPI_CPU_REQUEST"
          echo "  –†–µ—Å—É—Ä—Å—ã Celery:"
          echo "    CELERY_MEMORY_REQUEST=$CELERY_MEMORY_REQUEST"
          echo "    CELERY_CPU_REQUEST=$CELERY_CPU_REQUEST"
          echo "  –†–µ—Å—É—Ä—Å—ã Nginx:"
          echo "    NGINX_MEMORY_REQUEST=$NGINX_MEMORY_REQUEST"
          echo "    NGINX_CPU_REQUEST=$NGINX_CPU_REQUEST"
          echo "    NGINX_MEMORY_LIMIT=$NGINX_MEMORY_LIMIT"
          echo "    NGINX_CPU_LIMIT=$NGINX_CPU_LIMIT"
          echo "  –†–µ—Å—É—Ä—Å—ã Postgres:"
          echo "    POSTGRES_MEMORY_REQUEST=$POSTGRES_MEMORY_REQUEST"
          echo "    POSTGRES_CPU_REQUEST=$POSTGRES_CPU_REQUEST"
          echo "    POSTGRES_MEMORY_LIMIT=$POSTGRES_MEMORY_LIMIT"
          echo "    POSTGRES_CPU_LIMIT=$POSTGRES_CPU_LIMIT"
          echo "    POSTGRES_STORAGE_SIZE=$POSTGRES_STORAGE_SIZE"
          echo "    POSTGRES_IMAGE_TAG=$POSTGRES_IMAGE_TAG"
          echo "  –†–µ—Å—É—Ä—Å—ã Redis:"
          echo "    REDIS_MEMORY_REQUEST=$REDIS_MEMORY_REQUEST"
          echo "    REDIS_CPU_REQUEST=$REDIS_CPU_REQUEST"
          echo "    REDIS_MEMORY_LIMIT=$REDIS_MEMORY_LIMIT"
          echo "    REDIS_CPU_LIMIT=$REDIS_CPU_LIMIT"
          echo "    REDIS_STORAGE_SIZE=$REDIS_STORAGE_SIZE"
          echo "    REDIS_IMAGE_TAG=$REDIS_IMAGE_TAG"
          echo "  –•—Ä–∞–Ω–∏–ª–∏—â–µ:"
          echo "    IMAGES_STORAGE_SIZE=$IMAGES_STORAGE_SIZE"
          echo "  –î–æ–º–µ–Ω –∏ SSL:"
          echo "    DOMAIN=$DOMAIN"
          echo "    LETSENCRYPT_EMAIL=$LETSENCRYPT_EMAIL"
          echo "    LETSENCRYPT_SERVER=$LETSENCRYPT_SERVER"
          echo "  Health checks:"
          echo "    HEALTH_CHECK_INITIAL_DELAY=$HEALTH_CHECK_INITIAL_DELAY"
          echo "    HEALTH_CHECK_PERIOD=$HEALTH_CHECK_PERIOD"
          echo "    HEALTH_CHECK_TIMEOUT=$HEALTH_CHECK_TIMEOUT"
          echo "    HEALTH_CHECK_FAILURE_THRESHOLD=$HEALTH_CHECK_FAILURE_THRESHOLD"
          echo "    HEALTH_CHECK_READINESS_INITIAL_DELAY=$HEALTH_CHECK_READINESS_INITIAL_DELAY"
          echo "    HEALTH_CHECK_READINESS_PERIOD=$HEALTH_CHECK_READINESS_PERIOD"
          
          echo ""
          echo "=========================================="
          echo "=== –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã ==="
          echo "=========================================="
          
          # –ó–∞–º–µ–Ω—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã ${CI_REGISTRY_IMAGE}:latest / ${CI_REGISTRY_IMAGE}/nginx:latest –∏ IMAGE_PULL_SECRET_NAME –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
          echo ""
          echo "üîÑ –ó–∞–º–µ–Ω–∞ –æ–±—Ä–∞–∑–æ–≤ –∏ —Å–µ–∫—Ä–µ—Ç–æ–≤..."
          sed -i "s|\${CI_REGISTRY_IMAGE}:latest|$CI_REGISTRY_IMAGE:${CI_COMMIT_SHA}|g" k3s/fastapi-deployment.yaml || true
          sed -i "s|\${CI_REGISTRY_IMAGE}:latest|$CI_REGISTRY_IMAGE:${CI_COMMIT_SHA}|g" k3s/celery-deployment.yaml || true
          sed -i "s|\${CI_REGISTRY_IMAGE}/nginx:latest|$CI_REGISTRY_IMAGE/nginx:${CI_COMMIT_SHA}|g" k3s/nginx-deployment.yaml
          sed -i "s|\${IMAGE_PULL_SECRET_NAME}|$IMAGE_PULL_SECRET_NAME|g" k3s/fastapi-deployment.yaml
          sed -i "s|\${IMAGE_PULL_SECRET_NAME}|$IMAGE_PULL_SECRET_NAME|g" k3s/celery-deployment.yaml
          sed -i "s|\${IMAGE_PULL_SECRET_NAME}|$IMAGE_PULL_SECRET_NAME|g" k3s/nginx-deployment.yaml
          echo "  ‚úÖ –û–±—Ä–∞–∑—ã:"
          echo "    FastAPI: $CI_REGISTRY_IMAGE:${CI_COMMIT_SHA}"
          echo "    Celery: $CI_REGISTRY_IMAGE:${CI_COMMIT_SHA}"
          echo "    Nginx: $CI_REGISTRY_IMAGE/nginx:${CI_COMMIT_SHA}"
          echo "  ‚úÖ ImagePullSecret: $IMAGE_PULL_SECRET_NAME"

          # –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è FastAPI
          echo ""
          echo "üîÑ –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è FastAPI..."
          sed -i "s|\${FASTAPI_REPLICAS:-1}|$FASTAPI_REPLICAS|g" k3s/fastapi-deployment.yaml
          sed -i "s|\${FASTAPI_MEMORY_REQUEST:-256Mi}|$FASTAPI_MEMORY_REQUEST|g" k3s/fastapi-deployment.yaml
          sed -i "s|\${FASTAPI_CPU_REQUEST:-20m}|$FASTAPI_CPU_REQUEST|g" k3s/fastapi-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_INITIAL_DELAY:-30}|$HEALTH_CHECK_INITIAL_DELAY|g" k3s/fastapi-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_PERIOD:-10}|$HEALTH_CHECK_PERIOD|g" k3s/fastapi-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_TIMEOUT:-5}|$HEALTH_CHECK_TIMEOUT|g" k3s/fastapi-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_FAILURE_THRESHOLD:-3}|$HEALTH_CHECK_FAILURE_THRESHOLD|g" k3s/fastapi-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_READINESS_INITIAL_DELAY:-10}|$HEALTH_CHECK_READINESS_INITIAL_DELAY|g" k3s/fastapi-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_READINESS_PERIOD:-5}|$HEALTH_CHECK_READINESS_PERIOD|g" k3s/fastapi-deployment.yaml
          echo "  ‚úÖ FastAPI: replicas=$FASTAPI_REPLICAS, memory=$FASTAPI_MEMORY_REQUEST, cpu=$FASTAPI_CPU_REQUEST"

          # –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è Celery
          echo ""
          echo "üîÑ –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è Celery..."
          sed -i "s|\${CELERY_REPLICAS:-1}|$CELERY_REPLICAS|g" k3s/celery-deployment.yaml
          sed -i "s|\${CELERY_MEMORY_REQUEST:-128Mi}|$CELERY_MEMORY_REQUEST|g" k3s/celery-deployment.yaml
          sed -i "s|\${CELERY_CPU_REQUEST:-15m}|$CELERY_CPU_REQUEST|g" k3s/celery-deployment.yaml
          echo "  ‚úÖ Celery: replicas=$CELERY_REPLICAS, memory=$CELERY_MEMORY_REQUEST, cpu=$CELERY_CPU_REQUEST"

          # –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è Nginx
          echo ""
          echo "üîÑ –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è Nginx..."
          sed -i "s|\${NGINX_REPLICAS:-1}|$NGINX_REPLICAS|g" k3s/nginx-deployment.yaml
          sed -i "s|\${NGINX_MEMORY_REQUEST:-32Mi}|$NGINX_MEMORY_REQUEST|g" k3s/nginx-deployment.yaml
          sed -i "s|\${NGINX_CPU_REQUEST:-10m}|$NGINX_CPU_REQUEST|g" k3s/nginx-deployment.yaml
          sed -i "s|\${NGINX_MEMORY_LIMIT:-64Mi}|$NGINX_MEMORY_LIMIT|g" k3s/nginx-deployment.yaml
          sed -i "s|\${NGINX_CPU_LIMIT:-20m}|$NGINX_CPU_LIMIT|g" k3s/nginx-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_READINESS_INITIAL_DELAY:-10}|$HEALTH_CHECK_READINESS_INITIAL_DELAY|g" k3s/nginx-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_READINESS_INITIAL_DELAY:-5}|$HEALTH_CHECK_READINESS_INITIAL_DELAY|g" k3s/nginx-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_READINESS_PERIOD:-5}|$HEALTH_CHECK_READINESS_PERIOD|g" k3s/nginx-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_PERIOD:-10}|$HEALTH_CHECK_PERIOD|g" k3s/nginx-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_TIMEOUT:-5}|$HEALTH_CHECK_TIMEOUT|g" k3s/nginx-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_FAILURE_THRESHOLD:-3}|$HEALTH_CHECK_FAILURE_THRESHOLD|g" k3s/nginx-deployment.yaml
          echo "  ‚úÖ Nginx: replicas=$NGINX_REPLICAS, memory=$NGINX_MEMORY_REQUEST/$NGINX_MEMORY_LIMIT, cpu=$NGINX_CPU_REQUEST/$NGINX_CPU_LIMIT"

          # –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–µ–ø–ª–∏–∫ –∏ —Ä–∞–∑–º–µ—Ä–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–ª—è Postgres (—É–±–∏—Ä–∞–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –∏–∑ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞)
          echo ""
          echo "üîÑ –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è Postgres..."
          sed -i "s|\${POSTGRES_REPLICAS:-1}|$POSTGRES_REPLICAS|g" k3s/postgres-statefulset.yaml
          sed -i "s|\${POSTGRES_STORAGE_SIZE:-20Gi}|$POSTGRES_STORAGE_SIZE|g" k3s/postgres-statefulset.yaml
          sed -i "s|\${POSTGRES_MEMORY_REQUEST:-128Mi}|$POSTGRES_MEMORY_REQUEST|g" k3s/postgres-statefulset.yaml
          sed -i "s|\${POSTGRES_CPU_REQUEST:-40m}|$POSTGRES_CPU_REQUEST|g" k3s/postgres-statefulset.yaml
          sed -i "s|\${POSTGRES_MEMORY_LIMIT:-256Mi}|$POSTGRES_MEMORY_LIMIT|g" k3s/postgres-statefulset.yaml
          sed -i "s|\${POSTGRES_CPU_LIMIT:-60m}|$POSTGRES_CPU_LIMIT|g" k3s/postgres-statefulset.yaml
          sed -i "s|\${POSTGRES_IMAGE_TAG:-postgres:16}|$POSTGRES_IMAGE_TAG|g" k3s/postgres-statefulset.yaml
          sed -i "s|\${HEALTH_CHECK_INITIAL_DELAY:-30}|$HEALTH_CHECK_INITIAL_DELAY|g" k3s/postgres-statefulset.yaml
          sed -i "s|\${HEALTH_CHECK_PERIOD:-10}|$HEALTH_CHECK_PERIOD|g" k3s/postgres-statefulset.yaml
          sed -i "s|\${HEALTH_CHECK_TIMEOUT:-5}|$HEALTH_CHECK_TIMEOUT|g" k3s/postgres-statefulset.yaml
          sed -i "s|\${HEALTH_CHECK_FAILURE_THRESHOLD:-3}|$HEALTH_CHECK_FAILURE_THRESHOLD|g" k3s/postgres-statefulset.yaml
          echo "  ‚úÖ Postgres: replicas=$POSTGRES_REPLICAS, storage=$POSTGRES_STORAGE_SIZE, image=$POSTGRES_IMAGE_TAG"
          echo "    memory=$POSTGRES_MEMORY_REQUEST/$POSTGRES_MEMORY_LIMIT, cpu=$POSTGRES_CPU_REQUEST/$POSTGRES_CPU_LIMIT"

          # –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è Redis (—Ä–µ–ø–ª–∏–∫–∏, —Ä–µ—Å—É—Ä—Å—ã, PVC –∏ health-check)
          echo ""
          echo "üîÑ –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è Redis..."
          sed -i "s|\${REDIS_REPLICAS:-1}|$REDIS_REPLICAS|g" k3s/redis-deployment.yaml
          sed -i "s|\${REDIS_MEMORY_REQUEST:-64Mi}|$REDIS_MEMORY_REQUEST|g" k3s/redis-deployment.yaml
          sed -i "s|\${REDIS_CPU_REQUEST:-20m}|$REDIS_CPU_REQUEST|g" k3s/redis-deployment.yaml
          sed -i "s|\${REDIS_MEMORY_LIMIT:-128Mi}|$REDIS_MEMORY_LIMIT|g" k3s/redis-deployment.yaml
          sed -i "s|\${REDIS_CPU_LIMIT:-40m}|$REDIS_CPU_LIMIT|g" k3s/redis-deployment.yaml
          sed -i "s|\${REDIS_STORAGE_SIZE:-5Gi}|$REDIS_STORAGE_SIZE|g" k3s/redis-deployment.yaml
          sed -i "s|\${REDIS_IMAGE_TAG:-redis:7-alpine}|$REDIS_IMAGE_TAG|g" k3s/redis-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_INITIAL_DELAY:-30}|$HEALTH_CHECK_INITIAL_DELAY|g" k3s/redis-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_PERIOD:-10}|$HEALTH_CHECK_PERIOD|g" k3s/redis-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_TIMEOUT:-5}|$HEALTH_CHECK_TIMEOUT|g" k3s/redis-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_FAILURE_THRESHOLD:-3}|$HEALTH_CHECK_FAILURE_THRESHOLD|g" k3s/redis-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_READINESS_INITIAL_DELAY:-10}|$HEALTH_CHECK_READINESS_INITIAL_DELAY|g" k3s/redis-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_READINESS_PERIOD:-5}|$HEALTH_CHECK_READINESS_PERIOD|g" k3s/redis-deployment.yaml
          echo "  ‚úÖ Redis: replicas=$REDIS_REPLICAS, storage=$REDIS_STORAGE_SIZE, image=$REDIS_IMAGE_TAG"
          echo "    memory=$REDIS_MEMORY_REQUEST/$REDIS_MEMORY_LIMIT, cpu=$REDIS_CPU_REQUEST/$REDIS_CPU_LIMIT"

          # –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ PVC —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
          echo ""
          echo "üîÑ –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è PVC..."
          sed -i "s|\${IMAGES_STORAGE_SIZE:-5Gi}|$IMAGES_STORAGE_SIZE|g" k3s/pvc.yaml
          echo "  ‚úÖ Images PVC: storage=$IMAGES_STORAGE_SIZE"

          # –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–æ–º–µ–Ω–∞ –∏ email –≤ cert-manager –∏ Ingress
          echo ""
          echo "üîÑ –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è Ingress –∏ SSL..."
          sed -i "s|\${LETSENCRYPT_EMAIL:-arsen.davydov@gmail.com}|$LETSENCRYPT_EMAIL|g" k3s/cert-manager-issuer.yaml
          sed -i "s|\${DOMAIN:-async-black.ru}|$DOMAIN|g" k3s/ingress.yaml
          echo "  ‚úÖ Domain: $DOMAIN"
          echo "  ‚úÖ Let's Encrypt email: $LETSENCRYPT_EMAIL"
          echo "  ‚úÖ Let's Encrypt server: $LETSENCRYPT_SERVER"

          echo ""
          echo "=========================================="
          echo "‚úÖ –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã"
          echo "=========================================="
          echo ""
          echo "=== DEPLOY (GitHub): —Å–æ–∑–¥–∞–Ω–∏–µ ConfigMap –∏ Secret —á–µ—Ä–µ–∑ –æ–±—â–∏–π —Å–∫—Ä–∏–ø—Ç ==="
          ci/gitlab/create-configmap-and-secret.sh

          echo ""
          echo "=== DEPLOY (GitHub): –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤ —á–µ—Ä–µ–∑ –æ–±—â–∏–π —Å–∫—Ä–∏–ø—Ç ==="
          ci/gitlab/apply-manifests.sh

      - name: Wait for deployment and verify health
        env:
          DOMAIN: ${{ secrets.DOMAIN || 'async-black.ru' }}
          ROOT_PATH: ${{ secrets.ROOT_PATH || '/apps/shum-booking' }}
        run: |
          echo "=========================================="
          echo "=== VERIFY: –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ø–æ–¥–æ–≤ ==="
          echo "=========================================="
          echo ""
          
          echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ø–æ–¥–æ–≤ FastAPI..."
          kubectl wait --for=condition=ready pod \
            -l app=fastapi-app \
            -n booking \
            --timeout=300s || {
            echo "‚ùå FastAPI –ø–æ–¥—ã –Ω–µ —Å—Ç–∞–ª–∏ –≥–æ—Ç–æ–≤—ã –∑–∞ 5 –º–∏–Ω—É—Ç"
            kubectl -n booking get pods -l app=fastapi-app
            kubectl -n booking describe pod -l app=fastapi-app
            exit 1
          }
          
          echo "‚úÖ FastAPI –ø–æ–¥—ã –≥–æ—Ç–æ–≤—ã"
          
          echo ""
          echo "=========================================="
          echo "=== VERIFY: –ü—Ä–æ–≤–µ—Ä–∫–∞ health check ==="
          echo "=========================================="
          echo ""
          
          # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–¥–∞ FastAPI
          FASTAPI_POD=$(kubectl -n booking get pods -l app=fastapi-app -o jsonpath='{.items[0].metadata.name}')
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ health check —á–µ—Ä–µ–∑ pod: $FASTAPI_POD"
          
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º kubectl port-forward –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ endpoints
          echo "üì° –ù–∞—Å—Ç—Ä–æ–π–∫–∞ port-forward –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ endpoints..."
          kubectl -n booking port-forward "$FASTAPI_POD" 8000:8000 &
          PF_PID=$!
          sleep 5  # –î–∞—ë–º –≤—Ä–µ–º—è –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫—É —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º /ready endpoint
          echo "üì° –ü—Ä–æ–≤–µ—Ä–∫–∞ /ready endpoint..."
          if curl -s -f http://localhost:8000/ready > /dev/null; then
            echo "‚úÖ /ready endpoint –æ—Ç–≤–µ—á–∞–µ—Ç"
          else
            echo "‚ùå /ready endpoint –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
            kubectl -n booking logs "$FASTAPI_POD" --tail=50
            kill $PF_PID 2>/dev/null || true
            exit 1
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º /live endpoint
          echo "üì° –ü—Ä–æ–≤–µ—Ä–∫–∞ /live endpoint..."
          if curl -s -f http://localhost:8000/live > /dev/null; then
            echo "‚úÖ /live endpoint –æ—Ç–≤–µ—á–∞–µ—Ç"
          else
            echo "‚ùå /live endpoint –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
            kill $PF_PID 2>/dev/null || true
            exit 1
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º /health endpoint (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
          echo "üì° –ü—Ä–æ–≤–µ—Ä–∫–∞ /health endpoint..."
          if curl -s -f http://localhost:8000/health > /dev/null; then
            echo "‚úÖ /health endpoint –æ—Ç–≤–µ—á–∞–µ—Ç"
          else
            echo "‚ö†Ô∏è  /health endpoint –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)"
          fi
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º port-forward
          kill $PF_PID 2>/dev/null || true
          
          echo ""
          echo "‚úÖ –í—Å–µ health checks –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!"
          echo "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: https://${DOMAIN}${ROOT_PATH}/docs"


