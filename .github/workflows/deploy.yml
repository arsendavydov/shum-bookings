name: Deploy to K3s (production)

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      K3S_SERVER_IP: ${{ secrets.K3S_SERVER_IP }}
      K3S_SSH_USER: ${{ secrets.K3S_SSH_USER }}
      K3S_SSH_KEY_BASE64: ${{ secrets.K3S_SSH_KEY_BASE64 }}
      KUBE_NAMESPACE: booking
      # Базовый адрес Docker registry (по умолчанию GitLab Container Registry)
      CI_REGISTRY: ${{ secrets.CI_REGISTRY || 'registry.gitlab.com' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-client netcat-openbsd curl
          # Устанавливаем kubectl
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
          kubectl version --client

      - name: Login to Container Registry and build/push images
        env:
          CI_REGISTRY_IMAGE: ${{ secrets.CI_REGISTRY_IMAGE || 'registry.gitlab.com/shum-bookin/shum-booking' }}
          CI_REGISTRY: ${{ env.CI_REGISTRY }}
          CI_REGISTRY_USER: ${{ secrets.CI_REGISTRY_USER }}
          CI_REGISTRY_PASSWORD: ${{ secrets.CI_REGISTRY_PASSWORD }}
          CI_COMMIT_SHA: ${{ github.sha }}
        run: |
          if [ -z "$CI_REGISTRY_USER" ] || [ -z "$CI_REGISTRY_PASSWORD" ]; then
            echo "❌ CI_REGISTRY_USER или CI_REGISTRY_PASSWORD не настроены в GitHub Secrets – не можем залогиниться в реестр"
            exit 1
          fi

          echo "=== LOGIN: Docker registry $CI_REGISTRY ==="
          echo "$CI_REGISTRY_PASSWORD" | docker login "$CI_REGISTRY" -u "$CI_REGISTRY_USER" --password-stdin

          echo "=== BUILD: FastAPI образ (docker build & push) ==="
          cd fastapi
          docker build \
            -f Dockerfile.prod \
            -t "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA" \
            -t "$CI_REGISTRY_IMAGE:latest" \
            .
          docker push "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA"
          docker push "$CI_REGISTRY_IMAGE:latest"

          echo "=== BUILD: Nginx образ (docker build & push) ==="
          cd ../nginx
          docker build \
            -f Dockerfile \
            -t "$CI_REGISTRY_IMAGE/nginx:$CI_COMMIT_SHA" \
            -t "$CI_REGISTRY_IMAGE/nginx:latest" \
            .
          docker push "$CI_REGISTRY_IMAGE/nginx:$CI_COMMIT_SHA"
          docker push "$CI_REGISTRY_IMAGE/nginx:latest"

          echo "✅ Образы FastAPI и Nginx успешно собраны и отправлены в реестр"

      - name: Prepare SSH key
        run: |
          if [ -z "$K3S_SSH_KEY_BASE64" ] || [ -z "$K3S_SERVER_IP" ] || [ -z "$K3S_SSH_USER" ]; then
            echo "❌ K3S_SSH_KEY_BASE64, K3S_SERVER_IP или K3S_SSH_USER не настроены в GitHub Secrets!"
            exit 1
          fi
          mkdir -p ~/.ssh
          echo "$K3S_SSH_KEY_BASE64" | base64 -d > ~/.ssh/k3s_key
          chmod 600 ~/.ssh/k3s_key
          ssh-keyscan -H "$K3S_SERVER_IP" >> ~/.ssh/known_hosts 2>/dev/null || true
          echo "✅ SSH key and known_hosts configured"

      - name: Export CI vars and check ACTIVE_CI_PROVIDER
        run: |
          export K3S_SSH_KEY_PATH="$HOME/.ssh/k3s_key"
          export K3S_SSH_USER
          export K3S_SERVER_IP
          export K3S_SSH_HOST="$K3S_SSH_USER@$K3S_SERVER_IP"
          export KUBE_CONFIG_PATH="$HOME/.kube/config"
          chmod +x ci/gitlab/*.sh ci/common/*.sh || true
          export ACTIVE_CI_PROVIDER_EXPECTED=github
          ci/common/check-active-provider.sh || { echo "⚠️ ACTIVE_CI_PROVIDER не github, деплой из GitHub пропускаем"; exit 0; }

      - name: Get kubeconfig from server
        run: |
          ci/gitlab/get-kubeconfig.sh

      - name: Deploy manifests (reuse GitLab scripts)
        env:
          CI_REGISTRY_IMAGE: ${{ secrets.CI_REGISTRY_IMAGE }}
          CI_COMMIT_SHA: ${{ github.sha }}
          CI_REGISTRY: ${{ secrets.CI_REGISTRY }}
          CI_REGISTRY_USER: ${{ secrets.CI_REGISTRY_USER }}
          CI_REGISTRY_PASSWORD: ${{ secrets.CI_REGISTRY_PASSWORD }}
          IMAGE_PULL_SECRET_NAME: ${{ secrets.IMAGE_PULL_SECRET_NAME }}
        run: |
          echo "=== DEPLOY (GitHub): экспорт переменных и обновление тегов образов ==="
          : "${CI_REGISTRY:?CI_REGISTRY is required}"
          : "${CI_REGISTRY_USER:?CI_REGISTRY_USER is required}"
          : "${CI_REGISTRY_PASSWORD:?CI_REGISTRY_PASSWORD is required}"
          : "${CI_REGISTRY_IMAGE:?CI_REGISTRY_IMAGE is required}"
          : "${CI_COMMIT_SHA:?CI_COMMIT_SHA is required}"
          : "${IMAGE_PULL_SECRET_NAME:?IMAGE_PULL_SECRET_NAME is required}"

          export CI_REGISTRY
          export CI_REGISTRY_USER
          export CI_REGISTRY_PASSWORD
          export CI_REGISTRY_IMAGE
          export CI_COMMIT_SHA
          export IMAGE_PULL_SECRET_NAME
          export FASTAPI_REPLICAS=${FASTAPI_REPLICAS:-1}
          export CELERY_REPLICAS=${CELERY_REPLICAS:-1}
          export NGINX_REPLICAS=${NGINX_REPLICAS:-1}
          export POSTGRES_REPLICAS=${POSTGRES_REPLICAS:-1}
          export REDIS_REPLICAS=${REDIS_REPLICAS:-1}
          export FASTAPI_MEMORY_REQUEST=${FASTAPI_MEMORY_REQUEST:-256Mi}
          export FASTAPI_CPU_REQUEST=${FASTAPI_CPU_REQUEST:-20m}
          export CELERY_MEMORY_REQUEST=${CELERY_MEMORY_REQUEST:-128Mi}
          export CELERY_CPU_REQUEST=${CELERY_CPU_REQUEST:-15m}
          export NGINX_MEMORY_REQUEST=${NGINX_MEMORY_REQUEST:-32Mi}
          export NGINX_CPU_REQUEST=${NGINX_CPU_REQUEST:-10m}
          export NGINX_MEMORY_LIMIT=${NGINX_MEMORY_LIMIT:-64Mi}
          export NGINX_CPU_LIMIT=${NGINX_CPU_LIMIT:-20m}
          export POSTGRES_MEMORY_REQUEST=${POSTGRES_MEMORY_REQUEST:-128Mi}
          export POSTGRES_CPU_REQUEST=${POSTGRES_CPU_REQUEST:-40m}
          export POSTGRES_MEMORY_LIMIT=${POSTGRES_MEMORY_LIMIT:-256Mi}
          export POSTGRES_CPU_LIMIT=${POSTGRES_CPU_LIMIT:-60m}
          export REDIS_MEMORY_REQUEST=${REDIS_MEMORY_REQUEST:-64Mi}
          export REDIS_CPU_REQUEST=${REDIS_CPU_REQUEST:-20m}
          export REDIS_MEMORY_LIMIT=${REDIS_MEMORY_LIMIT:-128Mi}
          export REDIS_CPU_LIMIT=${REDIS_CPU_LIMIT:-40m}
          export POSTGRES_STORAGE_SIZE=${POSTGRES_STORAGE_SIZE:-20Gi}
          export REDIS_STORAGE_SIZE=${REDIS_STORAGE_SIZE:-5Gi}
          export IMAGES_STORAGE_SIZE=${IMAGES_STORAGE_SIZE:-5Gi}
          export POSTGRES_IMAGE_TAG=${POSTGRES_IMAGE_TAG:-postgres:16}
          export REDIS_IMAGE_TAG=${REDIS_IMAGE_TAG:-redis:7-alpine}
          export DOMAIN=${DOMAIN:-async-black.ru}
          export LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL:-arsen.davydov@gmail.com}
          export LETSENCRYPT_SERVER=${LETSENCRYPT_SERVER:-production}
          export HEALTH_CHECK_INITIAL_DELAY=${HEALTH_CHECK_INITIAL_DELAY:-30}
          export HEALTH_CHECK_PERIOD=${HEALTH_CHECK_PERIOD:-10}
          export HEALTH_CHECK_TIMEOUT=${HEALTH_CHECK_TIMEOUT:-5}
          export HEALTH_CHECK_FAILURE_THRESHOLD=${HEALTH_CHECK_FAILURE_THRESHOLD:-3}
          export HEALTH_CHECK_READINESS_INITIAL_DELAY=${HEALTH_CHECK_READINESS_INITIAL_DELAY:-10}
          export HEALTH_CHECK_READINESS_PERIOD=${HEALTH_CHECK_READINESS_PERIOD:-5}
          # Заменяем плейсхолдеры ${CI_REGISTRY_IMAGE}:latest / ${CI_REGISTRY_IMAGE}/nginx:latest и IMAGE_PULL_SECRET_NAME на конкретные значения
          sed -i "s|\${CI_REGISTRY_IMAGE}:latest|$CI_REGISTRY_IMAGE:${CI_COMMIT_SHA}|g" k3s/fastapi-deployment.yaml || true
          sed -i "s|\${CI_REGISTRY_IMAGE}:latest|$CI_REGISTRY_IMAGE:${CI_COMMIT_SHA}|g" k3s/celery-deployment.yaml || true
          sed -i "s|\${CI_REGISTRY_IMAGE}/nginx:latest|$CI_REGISTRY_IMAGE/nginx:${CI_COMMIT_SHA}|g" k3s/nginx-deployment.yaml
          sed -i "s|\${IMAGE_PULL_SECRET_NAME:-ghcr-registry-secret}|$IMAGE_PULL_SECRET_NAME|g" k3s/fastapi-deployment.yaml
          sed -i "s|\${IMAGE_PULL_SECRET_NAME:-ghcr-registry-secret}|$IMAGE_PULL_SECRET_NAME|g" k3s/celery-deployment.yaml
          sed -i "s|\${IMAGE_PULL_SECRET_NAME:-ghcr-registry-secret}|$IMAGE_PULL_SECRET_NAME|g" k3s/nginx-deployment.yaml

          # Подстановка переменных для FastAPI
          sed -i "s|\${FASTAPI_REPLICAS:-1}|$FASTAPI_REPLICAS|g" k3s/fastapi-deployment.yaml
          sed -i "s|\${FASTAPI_MEMORY_REQUEST:-256Mi}|$FASTAPI_MEMORY_REQUEST|g" k3s/fastapi-deployment.yaml
          sed -i "s|\${FASTAPI_CPU_REQUEST:-20m}|$FASTAPI_CPU_REQUEST|g" k3s/fastapi-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_INITIAL_DELAY:-30}|$HEALTH_CHECK_INITIAL_DELAY|g" k3s/fastapi-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_PERIOD:-10}|$HEALTH_CHECK_PERIOD|g" k3s/fastapi-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_TIMEOUT:-5}|$HEALTH_CHECK_TIMEOUT|g" k3s/fastapi-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_FAILURE_THRESHOLD:-3}|$HEALTH_CHECK_FAILURE_THRESHOLD|g" k3s/fastapi-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_READINESS_INITIAL_DELAY:-10}|$HEALTH_CHECK_READINESS_INITIAL_DELAY|g" k3s/fastapi-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_READINESS_PERIOD:-5}|$HEALTH_CHECK_READINESS_PERIOD|g" k3s/fastapi-deployment.yaml

          # Подстановка переменных для Celery
          sed -i "s|\${CELERY_REPLICAS:-1}|$CELERY_REPLICAS|g" k3s/celery-deployment.yaml
          sed -i "s|\${CELERY_MEMORY_REQUEST:-128Mi}|$CELERY_MEMORY_REQUEST|g" k3s/celery-deployment.yaml
          sed -i "s|\${CELERY_CPU_REQUEST:-15m}|$CELERY_CPU_REQUEST|g" k3s/celery-deployment.yaml

          # Подстановка переменных для Nginx
          sed -i "s|\${NGINX_REPLICAS:-1}|$NGINX_REPLICAS|g" k3s/nginx-deployment.yaml
          sed -i "s|\${NGINX_MEMORY_REQUEST:-32Mi}|$NGINX_MEMORY_REQUEST|g" k3s/nginx-deployment.yaml
          sed -i "s|\${NGINX_CPU_REQUEST:-10m}|$NGINX_CPU_REQUEST|g" k3s/nginx-deployment.yaml
          sed -i "s|\${NGINX_MEMORY_LIMIT:-64Mi}|$NGINX_MEMORY_LIMIT|g" k3s/nginx-deployment.yaml
          sed -i "s|\${NGINX_CPU_LIMIT:-20m}|$NGINX_CPU_LIMIT|g" k3s/nginx-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_READINESS_INITIAL_DELAY:-10}|$HEALTH_CHECK_READINESS_INITIAL_DELAY|g" k3s/nginx-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_READINESS_INITIAL_DELAY:-5}|$HEALTH_CHECK_READINESS_INITIAL_DELAY|g" k3s/nginx-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_READINESS_PERIOD:-5}|$HEALTH_CHECK_READINESS_PERIOD|g" k3s/nginx-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_PERIOD:-10}|$HEALTH_CHECK_PERIOD|g" k3s/nginx-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_TIMEOUT:-5}|$HEALTH_CHECK_TIMEOUT|g" k3s/nginx-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_FAILURE_THRESHOLD:-3}|$HEALTH_CHECK_FAILURE_THRESHOLD|g" k3s/nginx-deployment.yaml

          # Подстановка реплик и размера хранилища для Postgres (убираем плейсхолдеры из манифеста)
          sed -i "s|\${POSTGRES_REPLICAS:-1}|$POSTGRES_REPLICAS|g" k3s/postgres-statefulset.yaml
          sed -i "s|\${POSTGRES_STORAGE_SIZE:-20Gi}|$POSTGRES_STORAGE_SIZE|g" k3s/postgres-statefulset.yaml
          sed -i "s|\${POSTGRES_MEMORY_REQUEST:-128Mi}|$POSTGRES_MEMORY_REQUEST|g" k3s/postgres-statefulset.yaml
          sed -i "s|\${POSTGRES_CPU_REQUEST:-40m}|$POSTGRES_CPU_REQUEST|g" k3s/postgres-statefulset.yaml
          sed -i "s|\${POSTGRES_MEMORY_LIMIT:-256Mi}|$POSTGRES_MEMORY_LIMIT|g" k3s/postgres-statefulset.yaml
          sed -i "s|\${POSTGRES_CPU_LIMIT:-60m}|$POSTGRES_CPU_LIMIT|g" k3s/postgres-statefulset.yaml
          sed -i "s|\${POSTGRES_IMAGE_TAG:-postgres:16}|$POSTGRES_IMAGE_TAG|g" k3s/postgres-statefulset.yaml
          sed -i "s|\${HEALTH_CHECK_INITIAL_DELAY:-30}|$HEALTH_CHECK_INITIAL_DELAY|g" k3s/postgres-statefulset.yaml
          sed -i "s|\${HEALTH_CHECK_PERIOD:-10}|$HEALTH_CHECK_PERIOD|g" k3s/postgres-statefulset.yaml
          sed -i "s|\${HEALTH_CHECK_TIMEOUT:-5}|$HEALTH_CHECK_TIMEOUT|g" k3s/postgres-statefulset.yaml
          sed -i "s|\${HEALTH_CHECK_FAILURE_THRESHOLD:-3}|$HEALTH_CHECK_FAILURE_THRESHOLD|g" k3s/postgres-statefulset.yaml

          # Подстановка переменных для Redis (реплики, ресурсы, PVC и health-check)
          sed -i "s|\${REDIS_REPLICAS:-1}|$REDIS_REPLICAS|g" k3s/redis-deployment.yaml
          sed -i "s|\${REDIS_MEMORY_REQUEST:-64Mi}|$REDIS_MEMORY_REQUEST|g" k3s/redis-deployment.yaml
          sed -i "s|\${REDIS_CPU_REQUEST:-20m}|$REDIS_CPU_REQUEST|g" k3s/redis-deployment.yaml
          sed -i "s|\${REDIS_MEMORY_LIMIT:-128Mi}|$REDIS_MEMORY_LIMIT|g" k3s/redis-deployment.yaml
          sed -i "s|\${REDIS_CPU_LIMIT:-40m}|$REDIS_CPU_LIMIT|g" k3s/redis-deployment.yaml
          sed -i "s|\${REDIS_STORAGE_SIZE:-5Gi}|$REDIS_STORAGE_SIZE|g" k3s/redis-deployment.yaml
          sed -i "s|\${REDIS_IMAGE_TAG:-redis:7-alpine}|$REDIS_IMAGE_TAG|g" k3s/redis-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_INITIAL_DELAY:-30}|$HEALTH_CHECK_INITIAL_DELAY|g" k3s/redis-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_PERIOD:-10}|$HEALTH_CHECK_PERIOD|g" k3s/redis-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_TIMEOUT:-5}|$HEALTH_CHECK_TIMEOUT|g" k3s/redis-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_FAILURE_THRESHOLD:-3}|$HEALTH_CHECK_FAILURE_THRESHOLD|g" k3s/redis-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_READINESS_INITIAL_DELAY:-10}|$HEALTH_CHECK_READINESS_INITIAL_DELAY|g" k3s/redis-deployment.yaml
          sed -i "s|\${HEALTH_CHECK_READINESS_PERIOD:-5}|$HEALTH_CHECK_READINESS_PERIOD|g" k3s/redis-deployment.yaml

          # Подстановка размера PVC с изображениями
          sed -i "s|\${IMAGES_STORAGE_SIZE:-5Gi}|$IMAGES_STORAGE_SIZE|g" k3s/pvc.yaml

          # Подстановка домена и email в cert-manager и Ingress
          sed -i "s|\${LETSENCRYPT_EMAIL:-arsen.davydov@gmail.com}|$LETSENCRYPT_EMAIL|g" k3s/cert-manager-issuer.yaml
          sed -i "s|\${DOMAIN:-async-black.ru}|$DOMAIN|g" k3s/ingress.yaml

          echo "=== DEPLOY (GitHub): создание ConfigMap и Secret через общий скрипт ==="
          ci/gitlab/create-configmap-and-secret.sh

          echo "=== DEPLOY (GitHub): применение манифестов через общий скрипт ==="
          ci/gitlab/apply-manifests.sh


