# ============================================================================
# GitLab CI/CD Pipeline для деплоя в Kubernetes
# ============================================================================

stages:
  - build
  - deploy

variables:
  # Docker registry (GitLab Container Registry)
  CI_REGISTRY_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_PATH}
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  
  # Kubernetes
  KUBE_NAMESPACE: booking
  
  # Python
  PYTHONUNBUFFERED: "1"

# ============================================================================
# BUILD: Сборка Docker образов
# ============================================================================
build:fastapi:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "=== BUILD: FastAPI образ (docker build & push) ==="
    - cd fastapi
    - |
      docker build \
        -f Dockerfile.prod \
        -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA \
        -t $CI_REGISTRY_IMAGE:latest \
        .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
  only:
    - main
    - master
    - merge_requests

build:nginx:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "=== BUILD: Nginx образ (docker build & push) ==="
    - cd nginx
    - |
      docker build \
        -f Dockerfile \
        -t $CI_REGISTRY_IMAGE/nginx:$CI_COMMIT_SHA \
        -t $CI_REGISTRY_IMAGE/nginx:latest \
        .
    - docker push $CI_REGISTRY_IMAGE/nginx:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE/nginx:latest
  only:
    - main
    - master
    - merge_requests

# ============================================================================
# TEST: Временно отключено для быстрого деплоя
# ============================================================================

# DEPLOY: Деплой в Kubernetes
# ============================================================================
deploy:production:
  stage: deploy
  image: alpine/k8s:1.28.0
  before_script:
    - apk add --no-cache openssh-client netcat-openbsd
    - kubectl version --client
    - |
      if [ -z "$K3S_SSH_KEY_BASE64" ] || [ -z "$K3S_SERVER_IP" ] || [ -z "$K3S_SSH_USER" ]; then
        echo "❌ K3S_SSH_KEY_BASE64, K3S_SERVER_IP или K3S_SSH_USER не настроены!"
        exit 1
      fi
      mkdir -p ~/.ssh
      echo "$K3S_SSH_KEY_BASE64" | base64 -d > ~/.ssh/k3s_key
      chmod 600 ~/.ssh/k3s_key
      ssh-keyscan -H "$K3S_SERVER_IP" >> ~/.ssh/known_hosts 2>/dev/null || true
    - export K3S_SSH_KEY_PATH="$HOME/.ssh/k3s_key"
    - export K3S_SSH_USER
    - export K3S_SERVER_IP
    - export K3S_SSH_HOST="$K3S_SSH_USER@$K3S_SERVER_IP"
    - export KUBE_CONFIG_PATH="$HOME/.kube/config"
    - chmod +x ci/gitlab/*.sh ci/common/*.sh || true
    - export ACTIVE_CI_PROVIDER_EXPECTED=gitlab
    - ci/common/check-active-provider.sh || { echo "⚠️ ACTIVE_CI_PROVIDER не gitlab, деплой из GitLab пропускаем"; exit 0; }
    - ci/gitlab/get-kubeconfig.sh
  script:
    - |
      echo "=== DEPLOY: Шаг 1/3 — экспорт переменных ресурсов и health-check ==="
      export FASTAPI_REPLICAS=${FASTAPI_REPLICAS:-1}
      export CELERY_REPLICAS=${CELERY_REPLICAS:-1}
      export NGINX_REPLICAS=${NGINX_REPLICAS:-1}
      export POSTGRES_REPLICAS=${POSTGRES_REPLICAS:-1}
      export REDIS_REPLICAS=${REDIS_REPLICAS:-1}
      export FASTAPI_MEMORY_REQUEST=${FASTAPI_MEMORY_REQUEST:-256Mi}
      export FASTAPI_CPU_REQUEST=${FASTAPI_CPU_REQUEST:-20m}
      export CELERY_MEMORY_REQUEST=${CELERY_MEMORY_REQUEST:-128Mi}
      export CELERY_CPU_REQUEST=${CELERY_CPU_REQUEST:-15m}
      export NGINX_MEMORY_REQUEST=${NGINX_MEMORY_REQUEST:-32Mi}
      export NGINX_CPU_REQUEST=${NGINX_CPU_REQUEST:-10m}
      export NGINX_MEMORY_LIMIT=${NGINX_MEMORY_LIMIT:-64Mi}
      export NGINX_CPU_LIMIT=${NGINX_CPU_LIMIT:-20m}
      export POSTGRES_MEMORY_REQUEST=${POSTGRES_MEMORY_REQUEST:-128Mi}
      export POSTGRES_CPU_REQUEST=${POSTGRES_CPU_REQUEST:-40m}
      export POSTGRES_MEMORY_LIMIT=${POSTGRES_MEMORY_LIMIT:-256Mi}
      export POSTGRES_CPU_LIMIT=${POSTGRES_CPU_LIMIT:-60m}
      export REDIS_MEMORY_REQUEST=${REDIS_MEMORY_REQUEST:-64Mi}
      export REDIS_CPU_REQUEST=${REDIS_CPU_REQUEST:-20m}
      export REDIS_MEMORY_LIMIT=${REDIS_MEMORY_LIMIT:-128Mi}
      export REDIS_CPU_LIMIT=${REDIS_CPU_LIMIT:-40m}
      export POSTGRES_STORAGE_SIZE=${POSTGRES_STORAGE_SIZE:-20Gi}
      export REDIS_STORAGE_SIZE=${REDIS_STORAGE_SIZE:-5Gi}
      export IMAGES_STORAGE_SIZE=${IMAGES_STORAGE_SIZE:-5Gi}
      export POSTGRES_IMAGE_TAG=${POSTGRES_IMAGE_TAG:-postgres:16}
      export REDIS_IMAGE_TAG=${REDIS_IMAGE_TAG:-redis:7-alpine}
      export DOMAIN=${DOMAIN:-async-black.ru}
      export LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL:-arsen.davydov@gmail.com}
      export LETSENCRYPT_SERVER=${LETSENCRYPT_SERVER:-production}
      export HEALTH_CHECK_INITIAL_DELAY=${HEALTH_CHECK_INITIAL_DELAY:-30}
      export HEALTH_CHECK_PERIOD=${HEALTH_CHECK_PERIOD:-10}
      export HEALTH_CHECK_TIMEOUT=${HEALTH_CHECK_TIMEOUT:-5}
      export HEALTH_CHECK_FAILURE_THRESHOLD=${HEALTH_CHECK_FAILURE_THRESHOLD:-3}
      export HEALTH_CHECK_READINESS_INITIAL_DELAY=${HEALTH_CHECK_READINESS_INITIAL_DELAY:-10}
      export HEALTH_CHECK_READINESS_PERIOD=${HEALTH_CHECK_READINESS_PERIOD:-5}
      echo "=== DEPLOY: Шаг 2/3 — обновление тегов образов в манифестах ==="
      sed -i "s|${CI_REGISTRY_IMAGE}:latest|$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA|g" k3s/fastapi-deployment.yaml || true
      sed -i "s|\${CI_REGISTRY_IMAGE}/nginx:latest|$CI_REGISTRY_IMAGE/nginx:$CI_COMMIT_SHA|g" k3s/nginx-deployment.yaml
      # Подстановка переменных для FastAPI
      sed -i "s|\${FASTAPI_REPLICAS:-1}|$FASTAPI_REPLICAS|g" k3s/fastapi-deployment.yaml
      sed -i "s|\${FASTAPI_MEMORY_REQUEST:-256Mi}|$FASTAPI_MEMORY_REQUEST|g" k3s/fastapi-deployment.yaml
      sed -i "s|\${FASTAPI_CPU_REQUEST:-20m}|$FASTAPI_CPU_REQUEST|g" k3s/fastapi-deployment.yaml
      sed -i "s|\${HEALTH_CHECK_INITIAL_DELAY:-30}|$HEALTH_CHECK_INITIAL_DELAY|g" k3s/fastapi-deployment.yaml
      sed -i "s|\${HEALTH_CHECK_PERIOD:-10}|$HEALTH_CHECK_PERIOD|g" k3s/fastapi-deployment.yaml
      sed -i "s|\${HEALTH_CHECK_TIMEOUT:-5}|$HEALTH_CHECK_TIMEOUT|g" k3s/fastapi-deployment.yaml
      sed -i "s|\${HEALTH_CHECK_FAILURE_THRESHOLD:-3}|$HEALTH_CHECK_FAILURE_THRESHOLD|g" k3s/fastapi-deployment.yaml
      sed -i "s|\${HEALTH_CHECK_READINESS_INITIAL_DELAY:-10}|$HEALTH_CHECK_READINESS_INITIAL_DELAY|g" k3s/fastapi-deployment.yaml
      sed -i "s|\${HEALTH_CHECK_READINESS_PERIOD:-5}|$HEALTH_CHECK_READINESS_PERIOD|g" k3s/fastapi-deployment.yaml
      # Подстановка переменных для Celery
      sed -i "s|\${CELERY_REPLICAS:-1}|$CELERY_REPLICAS|g" k3s/celery-deployment.yaml
      sed -i "s|\${CELERY_MEMORY_REQUEST:-128Mi}|$CELERY_MEMORY_REQUEST|g" k3s/celery-deployment.yaml
      sed -i "s|\${CELERY_CPU_REQUEST:-15m}|$CELERY_CPU_REQUEST|g" k3s/celery-deployment.yaml
      # Подстановка переменных для Nginx
      sed -i "s|\${NGINX_REPLICAS:-1}|$NGINX_REPLICAS|g" k3s/nginx-deployment.yaml
      sed -i "s|\${NGINX_MEMORY_REQUEST:-32Mi}|$NGINX_MEMORY_REQUEST|g" k3s/nginx-deployment.yaml
      sed -i "s|\${NGINX_CPU_REQUEST:-10m}|$NGINX_CPU_REQUEST|g" k3s/nginx-deployment.yaml
      sed -i "s|\${NGINX_MEMORY_LIMIT:-64Mi}|$NGINX_MEMORY_LIMIT|g" k3s/nginx-deployment.yaml
      sed -i "s|\${NGINX_CPU_LIMIT:-20m}|$NGINX_CPU_LIMIT|g" k3s/nginx-deployment.yaml
      sed -i "s|\${HEALTH_CHECK_READINESS_INITIAL_DELAY:-10}|$HEALTH_CHECK_READINESS_INITIAL_DELAY|g" k3s/nginx-deployment.yaml
      sed -i "s|\${HEALTH_CHECK_READINESS_INITIAL_DELAY:-5}|$HEALTH_CHECK_READINESS_INITIAL_DELAY|g" k3s/nginx-deployment.yaml
      sed -i "s|\${HEALTH_CHECK_PERIOD:-10}|$HEALTH_CHECK_PERIOD|g" k3s/nginx-deployment.yaml
      sed -i "s|\${HEALTH_CHECK_TIMEOUT:-5}|$HEALTH_CHECK_TIMEOUT|g" k3s/nginx-deployment.yaml
      sed -i "s|\${HEALTH_CHECK_FAILURE_THRESHOLD:-3}|$HEALTH_CHECK_FAILURE_THRESHOLD|g" k3s/nginx-deployment.yaml
      # Подстановка реплик и размера хранилища для Postgres (убираем плейсхолдеры из манифеста)
      sed -i "s|\${POSTGRES_REPLICAS:-1}|$POSTGRES_REPLICAS|g" k3s/postgres-statefulset.yaml
      sed -i "s|\${POSTGRES_STORAGE_SIZE:-20Gi}|$POSTGRES_STORAGE_SIZE|g" k3s/postgres-statefulset.yaml
      sed -i "s|\${POSTGRES_MEMORY_REQUEST:-128Mi}|$POSTGRES_MEMORY_REQUEST|g" k3s/postgres-statefulset.yaml
      sed -i "s|\${POSTGRES_CPU_REQUEST:-40m}|$POSTGRES_CPU_REQUEST|g" k3s/postgres-statefulset.yaml
      sed -i "s|\${POSTGRES_MEMORY_LIMIT:-256Mi}|$POSTGRES_MEMORY_LIMIT|g" k3s/postgres-statefulset.yaml
      sed -i "s|\${POSTGRES_CPU_LIMIT:-60m}|$POSTGRES_CPU_LIMIT|g" k3s/postgres-statefulset.yaml
      sed -i "s|\${HEALTH_CHECK_INITIAL_DELAY:-30}|$HEALTH_CHECK_INITIAL_DELAY|g" k3s/postgres-statefulset.yaml
      sed -i "s|\${HEALTH_CHECK_PERIOD:-10}|$HEALTH_CHECK_PERIOD|g" k3s/postgres-statefulset.yaml
      sed -i "s|\${HEALTH_CHECK_TIMEOUT:-5}|$HEALTH_CHECK_TIMEOUT|g" k3s/postgres-statefulset.yaml
      sed -i "s|\${HEALTH_CHECK_FAILURE_THRESHOLD:-3}|$HEALTH_CHECK_FAILURE_THRESHOLD|g" k3s/postgres-statefulset.yaml
      # Подстановка переменных для Redis (реплики, ресурсы, PVC и health-check)
      sed -i "s|\${REDIS_REPLICAS:-1}|$REDIS_REPLICAS|g" k3s/redis-deployment.yaml
      sed -i "s|\${REDIS_MEMORY_REQUEST:-64Mi}|$REDIS_MEMORY_REQUEST|g" k3s/redis-deployment.yaml
      sed -i "s|\${REDIS_CPU_REQUEST:-20m}|$REDIS_CPU_REQUEST|g" k3s/redis-deployment.yaml
      sed -i "s|\${REDIS_MEMORY_LIMIT:-128Mi}|$REDIS_MEMORY_LIMIT|g" k3s/redis-deployment.yaml
      sed -i "s|\${REDIS_CPU_LIMIT:-40m}|$REDIS_CPU_LIMIT|g" k3s/redis-deployment.yaml
      sed -i "s|\${REDIS_STORAGE_SIZE:-5Gi}|$REDIS_STORAGE_SIZE|g" k3s/redis-deployment.yaml
      sed -i "s|\${HEALTH_CHECK_INITIAL_DELAY:-30}|$HEALTH_CHECK_INITIAL_DELAY|g" k3s/redis-deployment.yaml
      sed -i "s|\${HEALTH_CHECK_PERIOD:-10}|$HEALTH_CHECK_PERIOD|g" k3s/redis-deployment.yaml
      sed -i "s|\${HEALTH_CHECK_TIMEOUT:-5}|$HEALTH_CHECK_TIMEOUT|g" k3s/redis-deployment.yaml
      sed -i "s|\${HEALTH_CHECK_FAILURE_THRESHOLD:-3}|$HEALTH_CHECK_FAILURE_THRESHOLD|g" k3s/redis-deployment.yaml
      sed -i "s|\${HEALTH_CHECK_READINESS_INITIAL_DELAY:-10}|$HEALTH_CHECK_READINESS_INITIAL_DELAY|g" k3s/redis-deployment.yaml
      sed -i "s|\${HEALTH_CHECK_READINESS_PERIOD:-5}|$HEALTH_CHECK_READINESS_PERIOD|g" k3s/redis-deployment.yaml
      # Подстановка размера PVC с изображениями
      sed -i "s|\${IMAGES_STORAGE_SIZE:-5Gi}|$IMAGES_STORAGE_SIZE|g" k3s/pvc.yaml
    - echo "=== DEPLOY: Шаг 3/3 — создание ConfigMap и Secret ==="
    - ci/gitlab/create-configmap-and-secret.sh
    - echo "=== DEPLOY: Финальный шаг — применение Kubernetes манифестов ==="
    - ci/gitlab/apply-manifests.sh
  environment:
    name: production
    url: ${PRODUCTION_DOMAIN:-https://api.yourdomain.com}
  only:
    - main
    - master
  when: on_success

# ============================================================================
# ROLLBACK: Откат к предыдущей версии (ручной запуск)
# ============================================================================
rollback:production:
  stage: deploy
  image: alpine/k8s:1.28.0
  before_script:
    - apk add --no-cache openssh-client
    - |
      # Настройка SSH для получения kubeconfig
      if [ -z "$K3S_SSH_KEY_BASE64" ] || [ -z "$K3S_SERVER_IP" ] || [ -z "$K3S_SSH_USER" ]; then
        echo "❌ K3S_SSH_KEY_BASE64, K3S_SERVER_IP или K3S_SSH_USER не настроены!"
        exit 1
      fi
      mkdir -p ~/.ssh
      echo "$K3S_SSH_KEY_BASE64" | base64 -d > ~/.ssh/k3s_key
      chmod 600 ~/.ssh/k3s_key
      ssh-keyscan -H $K3S_SERVER_IP >> ~/.ssh/known_hosts 2>/dev/null || true
    - |
      # Получаем kubeconfig с сервера через SSH
      mkdir -p ~/.kube
      if ssh -i ~/.ssh/k3s_key \
          -o StrictHostKeyChecking=no \
          -o ConnectTimeout=10 \
          -o BatchMode=yes \
          $K3S_SSH_USER@$K3S_SERVER_IP "test -f ~/.kube/config && cat ~/.kube/config" > ~/.kube/config 2>/dev/null; then
        echo "✅ Kubeconfig получен"
      elif ssh -i ~/.ssh/k3s_key \
          -o StrictHostKeyChecking=no \
          -o ConnectTimeout=10 \
          -o BatchMode=yes \
          $K3S_SSH_USER@$K3S_SERVER_IP "sudo cat /etc/rancher/k3s/k3s.yaml" > ~/.kube/config 2>/dev/null; then
        echo "✅ Kubeconfig получен из /etc/rancher/k3s/k3s.yaml"
        sed -i "s|server: https://127.0.0.1:6443|server: https://$K3S_SERVER_IP:6443|g" ~/.kube/config
      else
        echo "❌ Не удалось получить kubeconfig с сервера!"
        exit 1
      fi
      chmod 600 ~/.kube/config
      export KUBECONFIG=~/.kube/config
  script:
    - echo "=== ROLLBACK: откат деплоя FastAPI и Celery ==="
    - kubectl rollout undo deployment/fastapi-app -n $KUBE_NAMESPACE
    - kubectl rollout undo deployment/celery-worker -n $KUBE_NAMESPACE
    - kubectl rollout status deployment/fastapi-app -n $KUBE_NAMESPACE --timeout=5m
    - kubectl rollout status deployment/celery-worker -n $KUBE_NAMESPACE --timeout=5m
    - echo "✅ Откат выполнен успешно!"
  when: manual
  only:
    - main
    - master

