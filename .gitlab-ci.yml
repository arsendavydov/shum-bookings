# ============================================================================
# GitLab CI/CD Pipeline –¥–ª—è –¥–µ–ø–ª–æ—è –≤ Kubernetes
# ============================================================================

stages:
  - build
  - deploy

variables:
  # Docker registry (GitLab Container Registry)
  CI_REGISTRY_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_PATH}
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  
  # Kubernetes
  KUBE_NAMESPACE: booking
  
  # Python
  PYTHONUNBUFFERED: "1"

# ============================================================================
# BUILD: –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤
# ============================================================================
build:fastapi:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - cd fastapi
    - |
      docker build \
        -f Dockerfile.prod \
        -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA \
        -t $CI_REGISTRY_IMAGE:latest \
        .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
  only:
    - main
    - master
    - merge_requests

build:nginx:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - cd nginx
    - |
      docker build \
        -f Dockerfile \
        -t $CI_REGISTRY_IMAGE/nginx:$CI_COMMIT_SHA \
        -t $CI_REGISTRY_IMAGE/nginx:latest \
        .
    - docker push $CI_REGISTRY_IMAGE/nginx:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE/nginx:latest
  only:
    - main
    - master
    - merge_requests

# ============================================================================
# TEST: –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–µ–ø–ª–æ—è
# ============================================================================

# DEPLOY: –î–µ–ø–ª–æ–π –≤ Kubernetes
# ============================================================================
deploy:production:
  stage: deploy
  image: alpine/k8s:1.28.0
  before_script:
    - apk add --no-cache openssh-client netcat-openbsd
    - kubectl version --client
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –¥–ª—è —Ç—É–Ω–Ω–µ–ª—è –∫ K3s
    - |
      if [ -z "$K3S_SSH_KEY_BASE64" ] || [ -z "$K3S_SERVER_IP" ] || [ -z "$K3S_SSH_USER" ]; then
        echo "‚ùå K3S_SSH_KEY_BASE64, K3S_SERVER_IP –∏–ª–∏ K3S_SSH_USER –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã!"
        exit 1
      fi
      mkdir -p ~/.ssh
      echo "$K3S_SSH_KEY_BASE64" | base64 -d > ~/.ssh/k3s_key
      chmod 600 ~/.ssh/k3s_key
      ssh-keyscan -H $K3S_SERVER_IP >> ~/.ssh/known_hosts 2>/dev/null || true
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ kubectl —á–µ—Ä–µ–∑ SSH —Ç—É–Ω–Ω–µ–ª—å
    - |
      if [ -n "$KUBECONFIG_BASE64" ]; then
        mkdir -p ~/.kube
        echo "$KUBECONFIG_BASE64" | base64 -d > ~/.kube/config
        # –ó–∞–º–µ–Ω—è–µ–º localhost –Ω–∞ IP —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è SSH —Ç—É–Ω–Ω–µ–ª—è
        sed -i "s|server: https://127.0.0.1:6443|server: https://$K3S_SERVER_IP:6443|g" ~/.kube/config
        chmod 600 ~/.kube/config
        export KUBECONFIG=~/.kube/config
      else
        echo "‚ùå KUBECONFIG_BASE64 –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
        exit 1
      fi
    # –°–æ–∑–¥–∞–µ–º SSH —Ç—É–Ω–Ω–µ–ª—å –≤ —Ñ–æ–Ω–µ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
    - |
      echo "üîó –°–æ–∑–¥–∞–Ω–∏–µ SSH —Ç—É–Ω–Ω–µ–ª—è –∫ K3s API..."
      # –£–±–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ SSH –ø—Ä–æ—Ü–µ—Å—Å—ã, –µ—Å–ª–∏ –µ—Å—Ç—å
      pkill -f "ssh.*6443:127.0.0.1:6443" || true
      sleep 1
      # –°–æ–∑–¥–∞–µ–º —Ç—É–Ω–Ω–µ–ª—å —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–ª—è –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
      ssh -i ~/.ssh/k3s_key \
          -o StrictHostKeyChecking=no \
          -o ServerAliveInterval=10 \
          -o ServerAliveCountMax=10 \
          -o ConnectTimeout=20 \
          -o TCPKeepAlive=yes \
          -o Compression=no \
          -o BatchMode=yes \
          -f -N -L 6443:127.0.0.1:6443 \
          $K3S_SSH_USER@$K3S_SERVER_IP
      sleep 3
      # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç—É–Ω–Ω–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç
      if ! nc -z 127.0.0.1 6443 2>/dev/null; then
        echo "‚ùå SSH —Ç—É–Ω–Ω–µ–ª—å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—ã—Ç–∞–µ–º—Å—è –µ—â–µ —Ä–∞–∑..."
        pkill -f "ssh.*6443:127.0.0.1:6443" || true
        sleep 2
        ssh -i ~/.ssh/k3s_key \
            -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=30 \
            -o ServerAliveCountMax=3 \
            -o ConnectTimeout=10 \
            -f -N -L 6443:127.0.0.1:6443 \
            $K3S_SSH_USER@$K3S_SERVER_IP
        sleep 3
      fi
      echo "‚úÖ SSH —Ç—É–Ω–Ω–µ–ª—å —Å–æ–∑–¥–∞–Ω"
    # –û–±–Ω–æ–≤–ª—è–µ–º kubeconfig –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è localhost —á–µ—Ä–µ–∑ —Ç—É–Ω–Ω–µ–ª—å
    - |
      sed -i "s|server: https://$K3S_SERVER_IP:6443|server: https://127.0.0.1:6443|g" ~/.kube/config
    # –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º–æ–∂–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è)
    - |
      echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–ª–∞—Å—Ç–µ—Ä—É..."
      # –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ—Ä—Ç –æ—Ç–∫—Ä—ã—Ç, kubectl –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–º
      if nc -z 127.0.0.1 6443 2>/dev/null; then
        echo "‚úÖ –ü–æ—Ä—Ç 6443 –¥–æ—Å—Ç—É–ø–µ–Ω, —Ç—É–Ω–Ω–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç"
        # –ü—Ä–æ–±—É–µ–º –±—ã—Å—Ç—Ä—É—é –ø—Ä–æ–≤–µ—Ä–∫—É (–±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è –¥–æ–ª–≥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞)
        timeout 10 kubectl get nodes --request-timeout=10s 2>&1 | head -5 || echo "‚ö†Ô∏è  kubectl –º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º..."
      else
        echo "‚ùå –ü–æ—Ä—Ç 6443 –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
        exit 1
      fi
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–µ–ø–ª–æ—è
  script:
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç—É–Ω–Ω–µ–ª—å –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤
    - |
      if ! nc -z 127.0.0.1 6443 2>/dev/null; then
        echo "‚ö†Ô∏è  –¢—É–Ω–Ω–µ–ª—å —Ä–∞–∑–æ—Ä–≤–∞–ª—Å—è, –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º..."
        pkill -f "ssh.*6443:127.0.0.1:6443" || true
        sleep 2
        ssh -i ~/.ssh/k3s_key \
            -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=30 \
            -o ServerAliveCountMax=3 \
            -o ConnectTimeout=10 \
            -f -N -L 6443:127.0.0.1:6443 \
            $K3S_SSH_USER@$K3S_SERVER_IP
        sleep 3
      fi
    # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–∑—ã –∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ deployment –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞—Ö
    - |
      # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –∑–∞–¥–∞–Ω—ã
      export FASTAPI_REPLICAS=${FASTAPI_REPLICAS:-1}
      export CELERY_REPLICAS=${CELERY_REPLICAS:-1}
      export NGINX_REPLICAS=${NGINX_REPLICAS:-1}
      export POSTGRES_REPLICAS=${POSTGRES_REPLICAS:-1}
      export REDIS_REPLICAS=${REDIS_REPLICAS:-1}
      
      export FASTAPI_MEMORY_REQUEST=${FASTAPI_MEMORY_REQUEST:-256Mi}
      export FASTAPI_CPU_REQUEST=${FASTAPI_CPU_REQUEST:-20m}
      export CELERY_MEMORY_REQUEST=${CELERY_MEMORY_REQUEST:-128Mi}
      export CELERY_CPU_REQUEST=${CELERY_CPU_REQUEST:-15m}
      export NGINX_MEMORY_REQUEST=${NGINX_MEMORY_REQUEST:-32Mi}
      export NGINX_CPU_REQUEST=${NGINX_CPU_REQUEST:-10m}
      export NGINX_MEMORY_LIMIT=${NGINX_MEMORY_LIMIT:-64Mi}
      export NGINX_CPU_LIMIT=${NGINX_CPU_LIMIT:-20m}
      export POSTGRES_MEMORY_REQUEST=${POSTGRES_MEMORY_REQUEST:-128Mi}
      export POSTGRES_CPU_REQUEST=${POSTGRES_CPU_REQUEST:-40m}
      export POSTGRES_MEMORY_LIMIT=${POSTGRES_MEMORY_LIMIT:-256Mi}
      export POSTGRES_CPU_LIMIT=${POSTGRES_CPU_LIMIT:-60m}
      export REDIS_MEMORY_REQUEST=${REDIS_MEMORY_REQUEST:-64Mi}
      export REDIS_CPU_REQUEST=${REDIS_CPU_REQUEST:-20m}
      export REDIS_MEMORY_LIMIT=${REDIS_MEMORY_LIMIT:-128Mi}
      export REDIS_CPU_LIMIT=${REDIS_CPU_LIMIT:-40m}
      
      export POSTGRES_STORAGE_SIZE=${POSTGRES_STORAGE_SIZE:-20Gi}
      export REDIS_STORAGE_SIZE=${REDIS_STORAGE_SIZE:-5Gi}
      export IMAGES_STORAGE_SIZE=${IMAGES_STORAGE_SIZE:-5Gi}
      
      export POSTGRES_IMAGE_TAG=${POSTGRES_IMAGE_TAG:-postgres:16}
      export REDIS_IMAGE_TAG=${REDIS_IMAGE_TAG:-redis:7-alpine}
      
      export HEALTH_CHECK_INITIAL_DELAY=${HEALTH_CHECK_INITIAL_DELAY:-30}
      export HEALTH_CHECK_PERIOD=${HEALTH_CHECK_PERIOD:-10}
      export HEALTH_CHECK_TIMEOUT=${HEALTH_CHECK_TIMEOUT:-5}
      export HEALTH_CHECK_FAILURE_THRESHOLD=${HEALTH_CHECK_FAILURE_THRESHOLD:-3}
      export HEALTH_CHECK_READINESS_INITIAL_DELAY=${HEALTH_CHECK_READINESS_INITIAL_DELAY:-10}
      export HEALTH_CHECK_READINESS_PERIOD=${HEALTH_CHECK_READINESS_PERIOD:-5}
      
      # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ YAML —Ñ–∞–π–ª–∞—Ö
      substitute_vars() {
        local file=$1
        # –û–±—Ä–∞–∑—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
        sed -i "s|registry.gitlab.com/arsen-davydov-main/shum_booking_v2:latest|$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA|g" "$file"
        sed -i "s|\${CI_REGISTRY_IMAGE}/nginx:latest|$CI_REGISTRY_IMAGE/nginx:$CI_COMMIT_SHA|g" "$file"
        
        # Kubernetes –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (replicas, resources, storage, images, health checks)
        # –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤ –Ω–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
        sed -i "s|\${FASTAPI_REPLICAS:-1}|$FASTAPI_REPLICAS|g" "$file"
        sed -i "s|\${CELERY_REPLICAS:-1}|$CELERY_REPLICAS|g" "$file"
        sed -i "s|\${NGINX_REPLICAS:-1}|$NGINX_REPLICAS|g" "$file"
        sed -i "s|\${POSTGRES_REPLICAS:-1}|$POSTGRES_REPLICAS|g" "$file"
        sed -i "s|\${REDIS_REPLICAS:-1}|$REDIS_REPLICAS|g" "$file"
        
        sed -i "s|\${FASTAPI_MEMORY_REQUEST:-256Mi}|$FASTAPI_MEMORY_REQUEST|g" "$file"
        sed -i "s|\${FASTAPI_CPU_REQUEST:-20m}|$FASTAPI_CPU_REQUEST|g" "$file"
        sed -i "s|\${CELERY_MEMORY_REQUEST:-128Mi}|$CELERY_MEMORY_REQUEST|g" "$file"
        sed -i "s|\${CELERY_CPU_REQUEST:-15m}|$CELERY_CPU_REQUEST|g" "$file"
        sed -i "s|\${NGINX_MEMORY_REQUEST:-32Mi}|$NGINX_MEMORY_REQUEST|g" "$file"
        sed -i "s|\${NGINX_CPU_REQUEST:-10m}|$NGINX_CPU_REQUEST|g" "$file"
        sed -i "s|\${NGINX_MEMORY_LIMIT:-64Mi}|$NGINX_MEMORY_LIMIT|g" "$file"
        sed -i "s|\${NGINX_CPU_LIMIT:-20m}|$NGINX_CPU_LIMIT|g" "$file"
        sed -i "s|\${POSTGRES_MEMORY_REQUEST:-128Mi}|$POSTGRES_MEMORY_REQUEST|g" "$file"
        sed -i "s|\${POSTGRES_CPU_REQUEST:-40m}|$POSTGRES_CPU_REQUEST|g" "$file"
        sed -i "s|\${POSTGRES_MEMORY_LIMIT:-256Mi}|$POSTGRES_MEMORY_LIMIT|g" "$file"
        sed -i "s|\${POSTGRES_CPU_LIMIT:-60m}|$POSTGRES_CPU_LIMIT|g" "$file"
        sed -i "s|\${REDIS_MEMORY_REQUEST:-64Mi}|$REDIS_MEMORY_REQUEST|g" "$file"
        sed -i "s|\${REDIS_CPU_REQUEST:-20m}|$REDIS_CPU_REQUEST|g" "$file"
        sed -i "s|\${REDIS_MEMORY_LIMIT:-128Mi}|$REDIS_MEMORY_LIMIT|g" "$file"
        sed -i "s|\${REDIS_CPU_LIMIT:-40m}|$REDIS_CPU_LIMIT|g" "$file"
        
        sed -i "s|\${POSTGRES_STORAGE_SIZE:-20Gi}|$POSTGRES_STORAGE_SIZE|g" "$file"
        sed -i "s|\${REDIS_STORAGE_SIZE:-5Gi}|$REDIS_STORAGE_SIZE|g" "$file"
        sed -i "s|\${IMAGES_STORAGE_SIZE:-5Gi}|$IMAGES_STORAGE_SIZE|g" "$file"
        
        sed -i "s|\${POSTGRES_IMAGE_TAG:-postgres:16}|$POSTGRES_IMAGE_TAG|g" "$file"
        sed -i "s|\${REDIS_IMAGE_TAG:-redis:7-alpine}|$REDIS_IMAGE_TAG|g" "$file"
        
        sed -i "s|\${HEALTH_CHECK_INITIAL_DELAY:-30}|$HEALTH_CHECK_INITIAL_DELAY|g" "$file"
        sed -i "s|\${HEALTH_CHECK_PERIOD:-10}|$HEALTH_CHECK_PERIOD|g" "$file"
        sed -i "s|\${HEALTH_CHECK_TIMEOUT:-5}|$HEALTH_CHECK_TIMEOUT|g" "$file"
        sed -i "s|\${HEALTH_CHECK_FAILURE_THRESHOLD:-3}|$HEALTH_CHECK_FAILURE_THRESHOLD|g" "$file"
        sed -i "s|\${HEALTH_CHECK_FAILURE_THRESHOLD:-5}|$HEALTH_CHECK_FAILURE_THRESHOLD|g" "$file"
        sed -i "s|\${HEALTH_CHECK_READINESS_INITIAL_DELAY:-10}|$HEALTH_CHECK_READINESS_INITIAL_DELAY|g" "$file"
        sed -i "s|\${HEALTH_CHECK_READINESS_INITIAL_DELAY:-5}|$HEALTH_CHECK_READINESS_INITIAL_DELAY|g" "$file"
        sed -i "s|\${HEALTH_CHECK_READINESS_PERIOD:-5}|$HEALTH_CHECK_READINESS_PERIOD|g" "$file"
      }
      
      echo "üîß –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ Kubernetes –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã..."
      substitute_vars k3s/fastapi-deployment.yaml
      substitute_vars k3s/celery-deployment.yaml
      substitute_vars k3s/nginx-deployment.yaml
      substitute_vars k3s/postgres-statefulset.yaml
      substitute_vars k3s/redis-deployment.yaml
      substitute_vars k3s/pvc.yaml
      echo "‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã"
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –≤ –æ–¥–Ω–æ–º –±–ª–æ–∫–µ
    - |
      # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è —Ç—É–Ω–Ω–µ–ª—è (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è - —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–∞)
      check_tunnel() {
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Ä—Ç (kubectl –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–º)
        if ! nc -z 127.0.0.1 6443 2>/dev/null; then
          echo "‚ö†Ô∏è  –¢—É–Ω–Ω–µ–ª—å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º..."
          pkill -f "ssh.*6443:127.0.0.1:6443" || true
          sleep 2
          # –°–æ–∑–¥–∞–µ–º —Ç—É–Ω–Ω–µ–ª—å —Å –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–ª—è –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
          ssh -i ~/.ssh/k3s_key \
              -o StrictHostKeyChecking=no \
              -o ServerAliveInterval=10 \
              -o ServerAliveCountMax=10 \
              -o ConnectTimeout=20 \
              -o TCPKeepAlive=yes \
              -o Compression=no \
              -o BatchMode=yes \
              -f -N -L 6443:127.0.0.1:6443 \
              $K3S_SSH_USER@$K3S_SERVER_IP
          sleep 3
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Ä—Ç
          for i in {1..3}; do
            if nc -z 127.0.0.1 6443 2>/dev/null; then
              echo "‚úÖ –¢—É–Ω–Ω–µ–ª—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
              return 0
            fi
            echo "   –ü—Ä–æ–≤–µ—Ä–∫–∞ $i/3..."
            sleep 2
          done
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç—É–Ω–Ω–µ–ª—å"
          return 1
        fi
        return 0
      }
      
      # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
      check_api() {
        local max_attempts=3
        for i in $(seq 1 $max_attempts); do
          if kubectl get --raw=/healthz --request-timeout=10s &>/dev/null; then
            return 0
          fi
          echo "   API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç, –ø–æ–ø—ã—Ç–∫–∞ $i/$max_attempts..."
          sleep 2
        done
        echo "‚ö†Ô∏è  API –º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º..."
        return 0
      }
      
      # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤ —Å retry
      apply_with_retry() {
        local file=$1
        local max_attempts=3
        for i in $(seq 1 $max_attempts); do
          echo "üîÑ –ü–æ–ø—ã—Ç–∫–∞ $i/$max_attempts –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è $file..."
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç—É–Ω–Ω–µ–ª—å –∏ API –ø–µ—Ä–µ–¥ –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–æ–π
          check_tunnel || true
          check_api || true
          # –ü—Ä–æ–±—É–µ–º –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —Ç–∞–π–º–∞—É—Ç–æ–º
          if kubectl apply -f "$file" --request-timeout=120s 2>&1; then
            echo "‚úÖ $file —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω"
            return 0
          else
            local exit_code=$?
            echo "‚è≥ –ü–æ–ø—ã—Ç–∫–∞ $i/$max_attempts –Ω–µ —É–¥–∞–ª–∞—Å—å (–∫–æ–¥: $exit_code), –ø–æ–≤—Ç–æ—Ä—è–µ–º..."
            sleep 5
          fi
        done
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å $file –ø–æ—Å–ª–µ $max_attempts –ø–æ–ø—ã—Ç–æ–∫"
        return 1
      }
      
      # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ç—É–Ω–Ω–µ–ª—è
      check_tunnel && apply_with_retry k3s/namespace.yaml
      check_tunnel && apply_with_retry k3s/storageclass.yaml
      # –°–æ–∑–¥–∞–Ω–∏–µ ConfigMap –∏ Secret –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö GitLab CI/CD
    - |
      check_tunnel() {
        if ! nc -z 127.0.0.1 6443 2>/dev/null; then
          echo "‚ö†Ô∏è  –¢—É–Ω–Ω–µ–ª—å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º..."
          pkill -f "ssh.*6443:127.0.0.1:6443" || true
          sleep 2
          ssh -i ~/.ssh/k3s_key \
              -o StrictHostKeyChecking=no \
              -o ServerAliveInterval=10 \
              -o ServerAliveCountMax=10 \
              -o ConnectTimeout=20 \
              -o TCPKeepAlive=yes \
              -o Compression=no \
              -o BatchMode=yes \
              -f -N -L 6443:127.0.0.1:6443 \
              $K3S_SSH_USER@$K3S_SERVER_IP
          sleep 3
        fi
      }
      
      check_api() {
        local max_attempts=3
        for i in $(seq 1 $max_attempts); do
          if kubectl get --raw=/healthz --request-timeout=10s &>/dev/null; then
            return 0
          fi
          sleep 2
        done
        return 0
      }
      
      check_tunnel && check_api
      
      echo "üìã –°–æ–∑–¥–∞–Ω–∏–µ ConfigMap booking-config –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö GitLab CI/CD..."
      
      # –£–¥–∞–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ ConfigMap (–µ—Å–ª–∏ –µ—Å—Ç—å)
      kubectl delete configmap booking-config -n $KUBE_NAMESPACE --ignore-not-found=true --request-timeout=30s || true
      
      # –°–æ–∑–¥–∞–Ω–∏–µ ConfigMap —Å –Ω–µ—Å–µ–∫—Ä–µ—Ç–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –∏–∑ GitLab CI/CD Variables
      # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ –∑–∞–¥–∞–Ω—ã
      kubectl create configmap booking-config \
        --from-literal=DB_HOST="${DB_HOST:-postgres-service}" \
        --from-literal=DB_PORT="${DB_PORT:-5432}" \
        --from-literal=DB_NAME="${DB_NAME:-booking}" \
        --from-literal=REDIS_HOST="${REDIS_HOST:-redis-service}" \
        --from-literal=REDIS_PORT="${REDIS_PORT:-6379}" \
        --from-literal=REDIS_DB="${REDIS_DB:-0}" \
        --from-literal=JWT_ALGORITHM="${JWT_ALGORITHM:-HS256}" \
        --from-literal=JWT_ACCESS_TOKEN_EXPIRE_MINUTES="${JWT_ACCESS_TOKEN_EXPIRE_MINUTES:-30}" \
        --from-literal=JWT_REFRESH_TOKEN_EXPIRE_DAYS="${JWT_REFRESH_TOKEN_EXPIRE_DAYS:-30}" \
        --from-literal=JWT_COOKIE_SECURE="${JWT_COOKIE_SECURE:-true}" \
        --from-literal=LOG_LEVEL="${LOG_LEVEL:-INFO}" \
        --from-literal=LOG_FORMAT_JSON="${LOG_FORMAT_JSON:-true}" \
        --from-literal=MAX_IMAGE_FILE_SIZE_MB="${MAX_IMAGE_FILE_SIZE_MB:-10}" \
        --from-literal=RATE_LIMIT_ENABLED="${RATE_LIMIT_ENABLED:-true}" \
        --from-literal=RATE_LIMIT_PER_MINUTE="${RATE_LIMIT_PER_MINUTE:-60}" \
        --from-literal=RATE_LIMIT_AUTH_PER_MINUTE="${RATE_LIMIT_AUTH_PER_MINUTE:-5}" \
        --from-literal=PYTHONUNBUFFERED="${PYTHONUNBUFFERED:-1}" \
        --from-literal=PYTHONDONTWRITEBYTECODE="${PYTHONDONTWRITEBYTECODE:-1}" \
        --from-literal=ROOT_PATH="${ROOT_PATH:-/apps/shum-booking}" \
        --namespace=$KUBE_NAMESPACE \
        --request-timeout=30s || {
          echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å ConfigMap, –≤–æ–∑–º–æ–∂–Ω–æ –æ–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
        }
      
      echo "‚úÖ ConfigMap booking-config —Å–æ–∑–¥–∞–Ω/–æ–±–Ω–æ–≤–ª–µ–Ω"
      
      # –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π rate limit –≤ nginx-configmap.yaml –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º
      echo "üîß –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π rate limit –≤ nginx-configmap.yaml..."
      # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ GitLab CI/CD Variables –∏–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      RATE_LIMIT_PER_MINUTE="${RATE_LIMIT_PER_MINUTE:-60}"
      RATE_LIMIT_AUTH_PER_MINUTE="${RATE_LIMIT_AUTH_PER_MINUTE:-5}"
      
      # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑—É—è sed
      cp k3s/nginx-configmap.yaml k3s/nginx-configmap-temp.yaml
      sed -i "s|\${RATE_LIMIT_PER_MINUTE:-60}|${RATE_LIMIT_PER_MINUTE}|g" k3s/nginx-configmap-temp.yaml
      sed -i "s|\${RATE_LIMIT_AUTH_PER_MINUTE:-5}|${RATE_LIMIT_AUTH_PER_MINUTE}|g" k3s/nginx-configmap-temp.yaml
      
      echo "üìã –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ nginx-configmap.yaml —Å rate limits:"
      echo "   RATE_LIMIT_PER_MINUTE=${RATE_LIMIT_PER_MINUTE} –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É"
      echo "   RATE_LIMIT_AUTH_PER_MINUTE=${RATE_LIMIT_AUTH_PER_MINUTE} –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É"
      check_tunnel && apply_with_retry k3s/nginx-configmap-temp.yaml
      
      # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
      rm -f k3s/nginx-configmap-temp.yaml
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π PVC –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (accessModes –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å)
    - |
      # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç—É–Ω–Ω–µ–ª—è (–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–∞–Ω–æ–≤–æ, —Ç.–∫. –∫–∞–∂–¥—ã–π –±–ª–æ–∫ - –Ω–æ–≤—ã–π shell)
      check_tunnel() {
        if ! nc -z 127.0.0.1 6443 2>/dev/null; then
          echo "‚ö†Ô∏è  –¢—É–Ω–Ω–µ–ª—å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º..."
          pkill -f "ssh.*6443:127.0.0.1:6443" || true
          sleep 2
          ssh -i ~/.ssh/k3s_key \
              -o StrictHostKeyChecking=no \
              -o ServerAliveInterval=10 \
              -o ServerAliveCountMax=10 \
              -o ConnectTimeout=20 \
              -o TCPKeepAlive=yes \
              -o Compression=no \
              -o BatchMode=yes \
              -f -N -L 6443:127.0.0.1:6443 \
              $K3S_SSH_USER@$K3S_SERVER_IP
          sleep 3
        fi
      }
      
      check_api() {
        local max_attempts=3
        for i in $(seq 1 $max_attempts); do
          if kubectl get --raw=/healthz --request-timeout=10s &>/dev/null; then
            return 0
          fi
          sleep 2
        done
        return 0
      }
      
      apply_with_retry() {
        local file=$1
        local max_attempts=3
        for i in $(seq 1 $max_attempts); do
          check_tunnel || true
          check_api || true
          if kubectl apply -f "$file" --request-timeout=120s 2>&1; then
            return 0
          else
            echo "‚è≥ –ü–æ–ø—ã—Ç–∫–∞ $i/$max_attempts –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø–æ–≤—Ç–æ—Ä—è–µ–º..."
            sleep 5
          fi
        done
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å $file –ø–æ—Å–ª–µ $max_attempts –ø–æ–ø—ã—Ç–æ–∫"
        return 1
      }
      
      if check_tunnel && check_api && kubectl get pvc booking-images-pvc -n $KUBE_NAMESPACE --request-timeout=30s &>/dev/null; then
        PVC_ACCESS_MODE=$(kubectl get pvc booking-images-pvc -n $KUBE_NAMESPACE -o jsonpath='{.spec.accessModes[0]}' 2>/dev/null || echo "")
        if [ "$PVC_ACCESS_MODE" != "ReadWriteOnce" ]; then
          echo "‚ö†Ô∏è  PVC booking-images-pvc –∏–º–µ–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π accessMode: $PVC_ACCESS_MODE"
          echo "   –£–¥–∞–ª—è–µ–º –ø–æ–¥—ã, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ PVC..."
          kubectl delete deployment fastapi-app celery-worker nginx -n $KUBE_NAMESPACE --ignore-not-found=true || true
          sleep 3
          echo "   –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π PVC..."
          kubectl delete pvc booking-images-pvc -n $KUBE_NAMESPACE --ignore-not-found=true || true
          sleep 2
          echo "   –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π PVC —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏..."
          apply_with_retry k3s/pvc.yaml
          echo "   –ñ–¥–µ–º —Å–æ–∑–¥–∞–Ω–∏—è PVC..."
          sleep 3
        else
          echo "‚úÖ PVC booking-images-pvc —É–∂–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π accessMode: ReadWriteOnce"
        fi
      else
        echo "üì¶ PVC booking-images-pvc –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º..."
        apply_with_retry k3s/pvc.yaml
        sleep 2
      fi
    # –°–æ–∑–¥–∞–Ω–∏–µ Secret –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö GitLab CI/CD (—Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ)
    - |
      check_tunnel() {
        if ! nc -z 127.0.0.1 6443 2>/dev/null; then
          echo "‚ö†Ô∏è  –¢—É–Ω–Ω–µ–ª—å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º..."
          pkill -f "ssh.*6443:127.0.0.1:6443" || true
          sleep 2
          ssh -i ~/.ssh/k3s_key \
              -o StrictHostKeyChecking=no \
              -o ServerAliveInterval=10 \
              -o ServerAliveCountMax=10 \
              -o ConnectTimeout=20 \
              -o TCPKeepAlive=yes \
              -o Compression=no \
              -o BatchMode=yes \
              -f -N -L 6443:127.0.0.1:6443 \
              $K3S_SSH_USER@$K3S_SERVER_IP
          sleep 3
        fi
      }
      
      check_api() {
        local max_attempts=3
        for i in $(seq 1 $max_attempts); do
          if kubectl get --raw=/healthz --request-timeout=10s &>/dev/null; then
            return 0
          fi
          sleep 2
        done
        return 0
      }
      
      check_tunnel && check_api
      
      echo "üîê –°–æ–∑–¥–∞–Ω–∏–µ Secret booking-secrets –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö GitLab CI/CD..."
      
      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Å–µ–∫—Ä–µ—Ç–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
      if [ -z "$DB_PASSWORD" ] || [ -z "$JWT_SECRET_KEY" ]; then
        echo "‚ö†Ô∏è  Warning: DB_PASSWORD –∏–ª–∏ JWT_SECRET_KEY –Ω–µ –∑–∞–¥–∞–Ω—ã –≤ GitLab CI/CD Variables!"
        echo "   Secret –Ω–µ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω/–æ–±–Ω–æ–≤–ª–µ–Ω."
        echo "   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ GitLab CI/CD Settings > CI/CD > Variables"
        if ! kubectl get secret booking-secrets -n $KUBE_NAMESPACE &>/dev/null; then
          echo "‚ùå Secret booking-secrets –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω –±–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö!"
          exit 1
        else
          echo "‚úÖ Secret booking-secrets —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π"
        fi
      else
        # –£–¥–∞–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ Secret (–µ—Å–ª–∏ –µ—Å—Ç—å)
        kubectl delete secret booking-secrets -n $KUBE_NAMESPACE --ignore-not-found=true --request-timeout=30s || true
        
        # –°–æ–∑–¥–∞–Ω–∏–µ Secret —Å —Å–µ–∫—Ä–µ—Ç–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –∏–∑ GitLab CI/CD Secret Variables
        kubectl create secret generic booking-secrets \
          --from-literal=DB_USERNAME="${DB_USERNAME:-postgres}" \
          --from-literal=DB_PASSWORD="$DB_PASSWORD" \
          --from-literal=JWT_SECRET_KEY="$JWT_SECRET_KEY" \
          --from-literal=REDIS_PASSWORD="${REDIS_PASSWORD:-}" \
          --namespace=$KUBE_NAMESPACE \
          --request-timeout=30s || {
            echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å Secret, –≤–æ–∑–º–æ–∂–Ω–æ –æ–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
          }
        
        echo "‚úÖ Secret booking-secrets —Å–æ–∑–¥–∞–Ω/–æ–±–Ω–æ–≤–ª–µ–Ω"
      fi
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ PVC —É–ø—Ä–æ—â–µ–Ω–∞ - –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    - kubectl get pvc -n $KUBE_NAMESPACE || true
    # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –∫—ç—à (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–µ—Ä–≤—ã–º–∏)
    # –ü—Ä–∏–º–µ–Ω—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ç—É–Ω–Ω–µ–ª—è
    - |
      check_tunnel() {
        if ! nc -z 127.0.0.1 6443 2>/dev/null; then
          echo "‚ö†Ô∏è  –¢—É–Ω–Ω–µ–ª—å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º..."
          pkill -f "ssh.*6443:127.0.0.1:6443" || true
          sleep 2
          ssh -i ~/.ssh/k3s_key \
              -o StrictHostKeyChecking=no \
              -o ServerAliveInterval=10 \
              -o ServerAliveCountMax=10 \
              -o ConnectTimeout=20 \
              -o TCPKeepAlive=yes \
              -o Compression=no \
              -o BatchMode=yes \
              -f -N -L 6443:127.0.0.1:6443 \
              $K3S_SSH_USER@$K3S_SERVER_IP
          sleep 3
        fi
      }
      
      check_api() {
        local max_attempts=3
        for i in $(seq 1 $max_attempts); do
          if kubectl get --raw=/healthz --request-timeout=10s &>/dev/null; then
            return 0
          fi
          sleep 2
        done
        return 0
      }
      
      apply_with_retry() {
        local file=$1
        local max_attempts=3
        for i in $(seq 1 $max_attempts); do
          check_tunnel || true
          check_api || true
          if kubectl apply -f "$file" --request-timeout=120s 2>&1; then
            return 0
          else
            echo "‚è≥ –ü–æ–ø—ã—Ç–∫–∞ $i/$max_attempts –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø–æ–≤—Ç–æ—Ä—è–µ–º..."
            sleep 5
          fi
        done
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å $file –ø–æ—Å–ª–µ $max_attempts –ø–æ–ø—ã—Ç–æ–∫"
        return 1
      }
      
      check_tunnel && check_api && apply_with_retry k3s/postgres-statefulset.yaml
      check_tunnel && apply_with_retry k3s/redis-deployment.yaml
      echo "üîÑ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ deployment'–æ–≤ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏..."
      check_tunnel && apply_with_retry k3s/fastapi-deployment.yaml
      check_tunnel && apply_with_retry k3s/fastapi-service.yaml
      check_tunnel && apply_with_retry k3s/celery-deployment.yaml
      check_tunnel && apply_with_retry k3s/nginx-deployment.yaml
      check_tunnel && apply_with_retry k3s/nginx-service.yaml
      check_tunnel && apply_with_retry k3s/ingress.yaml
    # –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ø–æ–¥–æ–≤ (–±–µ–∑ –¥–æ–ª–≥–æ–≥–æ –æ–∂–∏–¥–∞–Ω–∏—è)
    - echo "üìä –°—Ç–∞—Ç—É—Å –ø–æ–¥–æ–≤ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:"
    - kubectl get pods -n $KUBE_NAMESPACE
    - echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω! –ü–æ–¥—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –≤ —Ñ–æ–Ω–µ."
  environment:
    name: production
    url: ${PRODUCTION_DOMAIN:-https://api.yourdomain.com}  # –ù–∞—Å—Ç—Ä–æ–π—Ç–µ PRODUCTION_DOMAIN –≤ CI/CD Variables
  only:
    - main
    - master
  when: on_success

# ============================================================================
# ROLLBACK: –û—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ (—Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫)
# ============================================================================
rollback:production:
  stage: deploy
  image: alpine/k8s:1.28.0
  before_script:
    - |
      if [ -n "$KUBECONFIG_BASE64" ]; then
        mkdir -p ~/.kube
        echo "$KUBECONFIG_BASE64" | base64 -d > ~/.kube/config
        chmod 600 ~/.kube/config
        export KUBECONFIG=~/.kube/config
      else
        echo "‚ùå KUBECONFIG_BASE64 –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
        exit 1
      fi
  script:
    - kubectl rollout undo deployment/fastapi-app -n $KUBE_NAMESPACE
    - kubectl rollout undo deployment/celery-worker -n $KUBE_NAMESPACE
    - kubectl rollout status deployment/fastapi-app -n $KUBE_NAMESPACE --timeout=5m
    - kubectl rollout status deployment/celery-worker -n $KUBE_NAMESPACE --timeout=5m
    - echo "‚úÖ –û—Ç–∫–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
  when: manual
  only:
    - main
    - master

