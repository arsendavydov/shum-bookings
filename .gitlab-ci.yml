# ============================================================================
# GitLab CI/CD Pipeline –¥–ª—è –¥–µ–ø–ª–æ—è –≤ Kubernetes
# ============================================================================

stages:
  - build
  - test
  - deploy

variables:
  # Docker registry (GitLab Container Registry)
  CI_REGISTRY_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_PATH}
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  
  # Kubernetes
  KUBE_NAMESPACE: booking
  
  # Python
  PYTHONUNBUFFERED: "1"

# ============================================================================
# BUILD: –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤
# ============================================================================
build:fastapi:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - cd fastapi
    - |
      docker build \
        -f Dockerfile.prod \
        -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA \
        -t $CI_REGISTRY_IMAGE:latest \
        .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
  only:
    - main
    - master
    - merge_requests

build:nginx:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - cd nginx
    - |
      docker build \
        -f Dockerfile \
        -t $CI_REGISTRY_IMAGE/nginx:$CI_COMMIT_SHA \
        -t $CI_REGISTRY_IMAGE/nginx:latest \
        .
    - docker push $CI_REGISTRY_IMAGE/nginx:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE/nginx:latest
  only:
    - main
    - master
    - merge_requests

# ============================================================================
# TEST: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
# ============================================================================
test:
  stage: test
  image: python:3.11
  services:
    - name: postgres:16
      alias: postgres-test
      variables:
        POSTGRES_USER: postgres
        POSTGRES_PASSWORD: postgres
        POSTGRES_DB: test
    - name: redis:7-alpine
      alias: redis-test
  variables:
    DB_HOST: postgres-test
    DB_PORT: 5432
    DB_NAME: test
    DB_USERNAME: postgres
    DB_PASSWORD: postgres
    REDIS_HOST: redis-test
    REDIS_PORT: 6379
    REDIS_DB: 0
    JWT_SECRET_KEY: test_secret_key_for_ci_cd
    JWT_ALGORITHM: HS256
    JWT_ACCESS_TOKEN_EXPIRE_MINUTES: 30
    JWT_REFRESH_TOKEN_EXPIRE_DAYS: 30
    JWT_COOKIE_SECURE: "false"
    LOG_LEVEL: INFO
    LOG_FORMAT_JSON: "false"
    MAX_IMAGE_FILE_SIZE_MB: 10
    RATE_LIMIT_ENABLED: "false"
    RATE_LIMIT_PER_MINUTE: 60
    RATE_LIMIT_AUTH_PER_MINUTE: 5
    ENABLE_METRICS_IN_TESTS: "true"
    TEST_PASSWORD: testpass123
    TEST_EXAMPLE_EMAIL_DOMAIN: shum-booking.com
  before_script:
    - cd fastapi
    - apt-get update -qq && apt-get install -y -qq postgresql-client redis-tools || true
    - pip install --no-cache-dir -r requirements.txt
    - pip install pytest pytest-asyncio httpx
  script:
    # –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ë–î
    - |
      until pg_isready -h $DB_HOST -p $DB_PORT -U $DB_USERNAME; do
        echo "Waiting for PostgreSQL..."
        sleep 2
      done
    # –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Redis
    - |
      until redis-cli -h $REDIS_HOST -p $REDIS_PORT ping; do
        echo "Waiting for Redis..."
        sleep 2
      done
    # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
    - python -m alembic upgrade head
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
    - |
      pytest tests/unit_tests/ -v --tb=short || true
      pytest tests/api_tests/ -v --tb=short || true
      pytest tests/database_tests/ -v --tb=short || true
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏
    - |
      if [ $? -ne 0 ]; then
        echo "‚ùå –¢–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏!"
        exit 1
      else
        echo "‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!"
      fi
  artifacts:
    when: always
    reports:
      junit: fastapi/tests/reports/junit.xml
    paths:
      - fastapi/tests/reports/
    expire_in: 1 week
  only:
    - main
    - master
    - merge_requests

# ============================================================================
# DEPLOY: –î–µ–ø–ª–æ–π –≤ Kubernetes
# ============================================================================
deploy:production:
  stage: deploy
  image: alpine/k8s:1.28.0
  before_script:
    - apk add --no-cache openssh-client
    - kubectl version --client
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –¥–ª—è —Ç—É–Ω–Ω–µ–ª—è –∫ K3s
    - |
      if [ -z "$K3S_SSH_KEY_BASE64" ] || [ -z "$K3S_SERVER_IP" ] || [ -z "$K3S_SSH_USER" ]; then
        echo "‚ùå K3S_SSH_KEY_BASE64, K3S_SERVER_IP –∏–ª–∏ K3S_SSH_USER –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã!"
        exit 1
      fi
      mkdir -p ~/.ssh
      echo "$K3S_SSH_KEY_BASE64" | base64 -d > ~/.ssh/k3s_key
      chmod 600 ~/.ssh/k3s_key
      ssh-keyscan -H $K3S_SERVER_IP >> ~/.ssh/known_hosts 2>/dev/null || true
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ kubectl —á–µ—Ä–µ–∑ SSH —Ç—É–Ω–Ω–µ–ª—å
    - |
      if [ -n "$KUBECONFIG_BASE64" ]; then
        mkdir -p ~/.kube
        echo "$KUBECONFIG_BASE64" | base64 -d > ~/.kube/config
        # –ó–∞–º–µ–Ω—è–µ–º localhost –Ω–∞ IP —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è SSH —Ç—É–Ω–Ω–µ–ª—è
        sed -i "s|server: https://127.0.0.1:6443|server: https://$K3S_SERVER_IP:6443|g" ~/.kube/config
        chmod 600 ~/.kube/config
        export KUBECONFIG=~/.kube/config
      else
        echo "‚ùå KUBECONFIG_BASE64 –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
        exit 1
      fi
    # –°–æ–∑–¥–∞–µ–º SSH —Ç—É–Ω–Ω–µ–ª—å –≤ —Ñ–æ–Ω–µ
    - |
      ssh -i ~/.ssh/k3s_key -o StrictHostKeyChecking=no -f -N -L 6443:127.0.0.1:6443 $K3S_SSH_USER@$K3S_SERVER_IP || true
      sleep 2
    # –û–±–Ω–æ–≤–ª—è–µ–º kubeconfig –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è localhost —á–µ—Ä–µ–∑ —Ç—É–Ω–Ω–µ–ª—å
    - |
      sed -i "s|server: https://$K3S_SERVER_IP:6443|server: https://127.0.0.1:6443|g" ~/.kube/config
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–ª–∞—Å—Ç–µ—Ä—É
    - kubectl cluster-info
    - kubectl get nodes
  script:
    # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–∑—ã –≤ deployment –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞—Ö
    - |
      sed -i "s|registry.gitlab.com/arsen-davydov-main/shum_booking_v2:latest|$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA|g" k3s/fastapi-deployment.yaml
      sed -i "s|registry.gitlab.com/arsen-davydov-main/shum_booking_v2:latest|$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA|g" k3s/celery-deployment.yaml
      sed -i "s|\${CI_REGISTRY_IMAGE}/nginx:latest|$CI_REGISTRY_IMAGE/nginx:$CI_COMMIT_SHA|g" k3s/nginx-deployment.yaml
    # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
    - kubectl apply -f k3s/namespace.yaml
    - kubectl apply -f k3s/storageclass.yaml  # StorageClass –¥–ª—è K3s
    - kubectl apply -f k3s/configmap.yaml
    - kubectl apply -f k3s/nginx-configmap.yaml
    - kubectl apply -f k3s/pvc.yaml
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ–∫—Ä–µ—Ç—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω—ã –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ create-secrets.sh)
    - |
      if ! kubectl get secret booking-secrets -n $KUBE_NAMESPACE &>/dev/null; then
        echo "‚ö†Ô∏è  Warning: secret booking-secrets –Ω–µ –Ω–∞–π–¥–µ–Ω!"
        echo "   –°–µ–∫—Ä–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω—ã –≤—Ä—É—á–Ω—É—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —á–µ—Ä–µ–∑:"
        echo "   ./k3s/create-secrets.sh"
        echo "   –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–µ–ø–ª–æ–π, –Ω–æ PostgreSQL –º–æ–∂–µ—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è..."
      else
        echo "‚úÖ Secret booking-secrets –Ω–∞–π–¥–µ–Ω"
      fi
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å PVC –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º StatefulSet
    - echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ PVC:"
    - kubectl get pvc -n $KUBE_NAMESPACE || true
    # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –∫—ç—à (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–µ—Ä–≤—ã–º–∏)
    - kubectl apply -f k3s/postgres-statefulset.yaml
    - kubectl apply -f k3s/redis-deployment.yaml
    # –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    - kubectl apply -f k3s/fastapi-deployment.yaml
    - kubectl apply -f k3s/fastapi-service.yaml
    - kubectl apply -f k3s/celery-deployment.yaml
    # Nginx
    - kubectl apply -f k3s/nginx-deployment.yaml
    - kubectl apply -f k3s/nginx-service.yaml
    # Ingress (–ø–æ—Å–ª–µ–¥–Ω–∏–º)
    - kubectl apply -f k3s/ingress.yaml
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ–∫—Ä–µ—Ç—ã –∏ –∫–æ–Ω—Ñ–∏–≥–º–∞–ø—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
    - kubectl get secrets -n $KUBE_NAMESPACE
    - kubectl get configmaps -n $KUBE_NAMESPACE
    # –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ø–æ–¥–æ–≤ —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
    - |
      echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ PostgreSQL..."
      if ! kubectl rollout status statefulset/postgres -n $KUBE_NAMESPACE --timeout=5m; then
        echo "‚ùå PostgreSQL –Ω–µ —Å—Ç–∞–ª ready. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:"
        echo "üìä –°—Ç–∞—Ç—É—Å –ø–æ–¥–æ–≤:"
        kubectl get pods -n $KUBE_NAMESPACE -l app=postgres -o wide
        echo ""
        echo "üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–¥–∞:"
        kubectl describe pod -n $KUBE_NAMESPACE -l app=postgres | tail -100
        echo ""
        echo "üìù –õ–æ–≥–∏ –ø–æ–¥–∞:"
        kubectl logs -n $KUBE_NAMESPACE -l app=postgres --tail=100 || true
        echo ""
        echo "üì¶ –°—Ç–∞—Ç—É—Å PVC:"
        kubectl get pvc -n $KUBE_NAMESPACE | grep postgres || true
        echo ""
        echo "üìä –°–æ–±—ã—Ç–∏—è –≤ namespace:"
        kubectl get events -n $KUBE_NAMESPACE --sort-by='.lastTimestamp' | tail -20 || true
        exit 1
      fi
    - |
      echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Redis..."
      if ! kubectl rollout status deployment/redis -n $KUBE_NAMESPACE --timeout=5m; then
        echo "‚ùå Redis –Ω–µ —Å—Ç–∞–ª ready. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:"
        kubectl get pods -n $KUBE_NAMESPACE -l app=redis
        kubectl describe pod -n $KUBE_NAMESPACE -l app=redis | tail -50
        kubectl logs -n $KUBE_NAMESPACE -l app=redis --tail=50 || true
        exit 1
      fi
    - |
      echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ FastAPI..."
      if ! kubectl rollout status deployment/fastapi-app -n $KUBE_NAMESPACE --timeout=5m; then
        echo "‚ùå FastAPI –Ω–µ —Å—Ç–∞–ª ready. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:"
        kubectl get pods -n $KUBE_NAMESPACE -l app=fastapi-app
        kubectl describe pod -n $KUBE_NAMESPACE -l app=fastapi-app | tail -50
        kubectl logs -n $KUBE_NAMESPACE -l app=fastapi-app --tail=50 || true
        exit 1
      fi
    - |
      echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Celery..."
      if ! kubectl rollout status deployment/celery-worker -n $KUBE_NAMESPACE --timeout=5m; then
        echo "‚ùå Celery –Ω–µ —Å—Ç–∞–ª ready. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:"
        kubectl get pods -n $KUBE_NAMESPACE -l app=celery-worker
        kubectl describe pod -n $KUBE_NAMESPACE -l app=celery-worker | tail -50
        kubectl logs -n $KUBE_NAMESPACE -l app=celery-worker --tail=50 || true
        exit 1
      fi
    - |
      echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Nginx..."
      if ! kubectl rollout status deployment/nginx -n $KUBE_NAMESPACE --timeout=5m; then
        echo "‚ùå Nginx –Ω–µ —Å—Ç–∞–ª ready. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:"
        kubectl get pods -n $KUBE_NAMESPACE -l app=nginx
        kubectl describe pod -n $KUBE_NAMESPACE -l app=nginx | tail -50
        kubectl logs -n $KUBE_NAMESPACE -l app=nginx --tail=50 || true
        exit 1
      fi
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
    - echo "üìä –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø–æ–¥–æ–≤:"
    - kubectl get pods -n $KUBE_NAMESPACE -o wide
    - echo "üìä –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
    - kubectl get services -n $KUBE_NAMESPACE
    - echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
  environment:
    name: production
    url: ${PRODUCTION_DOMAIN:-https://api.yourdomain.com}  # –ù–∞—Å—Ç—Ä–æ–π—Ç–µ PRODUCTION_DOMAIN –≤ CI/CD Variables
  only:
    - main
    - master
  when: on_success

# ============================================================================
# ROLLBACK: –û—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ (—Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫)
# ============================================================================
rollback:production:
  stage: deploy
  image: alpine/k8s:1.28.0
  before_script:
    - |
      if [ -n "$KUBECONFIG_BASE64" ]; then
        mkdir -p ~/.kube
        echo "$KUBECONFIG_BASE64" | base64 -d > ~/.kube/config
        chmod 600 ~/.kube/config
        export KUBECONFIG=~/.kube/config
      else
        echo "‚ùå KUBECONFIG_BASE64 –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
        exit 1
      fi
  script:
    - kubectl rollout undo deployment/fastapi-app -n $KUBE_NAMESPACE
    - kubectl rollout undo deployment/celery-worker -n $KUBE_NAMESPACE
    - kubectl rollout status deployment/fastapi-app -n $KUBE_NAMESPACE --timeout=5m
    - kubectl rollout status deployment/celery-worker -n $KUBE_NAMESPACE --timeout=5m
    - echo "‚úÖ –û—Ç–∫–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
  when: manual
  only:
    - main
    - master

