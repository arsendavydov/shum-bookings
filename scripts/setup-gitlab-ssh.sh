#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ GitLab

set -e

echo "üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ GitLab"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–ª—é—á–∏
echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö SSH –∫–ª—é—á–µ–π..."
if [ -f ~/.ssh/id_ed25519.pub ] || [ -f ~/.ssh/id_rsa.pub ]; then
    echo "‚úÖ –ù–∞–π–¥–µ–Ω—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ SSH –∫–ª—é—á–∏:"
    ls -la ~/.ssh/*.pub 2>/dev/null || true
    
    read -p "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–ª—é—á? (y/n): " USE_EXISTING
    if [ "$USE_EXISTING" = "y" ] || [ "$USE_EXISTING" = "Y" ]; then
        if [ -f ~/.ssh/id_ed25519.pub ]; then
            KEY_FILE=~/.ssh/id_ed25519
            KEY_TYPE="ed25519"
        elif [ -f ~/.ssh/id_rsa.pub ]; then
            KEY_FILE=~/.ssh/id_rsa
            KEY_TYPE="rsa"
        fi
    else
        USE_EXISTING="n"
    fi
else
    USE_EXISTING="n"
fi

# –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∫–ª—é—á, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
if [ "$USE_EXISTING" != "y" ]; then
    echo ""
    echo "üîë –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ SSH –∫–ª—é—á–∞..."
    read -p "–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è –∫–ª—é—á–∞ (–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ): " EMAIL
    
    if [ -z "$EMAIL" ]; then
        EMAIL=$(git config user.email 2>/dev/null || echo "$USER@$(hostname)")
    fi
    
    KEY_FILE=~/.ssh/id_ed25519_gitlab
    KEY_TYPE="ed25519"
    
    echo "–°–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–∞: $KEY_FILE"
    ssh-keygen -t ed25519 -C "$EMAIL" -f "$KEY_FILE" -N ""
    
    echo "‚úÖ SSH –∫–ª—é—á —Å–æ–∑–¥–∞–Ω: $KEY_FILE"
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á
echo ""
echo "üìã –í–∞—à –ø—É–±–ª–∏—á–Ω—ã–π SSH –∫–ª—é—á:"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
cat "${KEY_FILE}.pub"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""

# –î–æ–±–∞–≤–ª—è–µ–º –∫–ª—é—á –≤ ssh-agent
echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ssh-agent..."
eval "$(ssh-agent -s)" >/dev/null 2>&1

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏ –∫–ª—é—á
if ! ssh-add -l | grep -q "$(basename $KEY_FILE)"; then
    ssh-add "$KEY_FILE"
    echo "‚úÖ –ö–ª—é—á –¥–æ–±–∞–≤–ª–µ–Ω –≤ ssh-agent"
else
    echo "‚úÖ –ö–ª—é—á —É–∂–µ –≤ ssh-agent"
fi

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SSH config –¥–ª—è GitLab
echo ""
echo "üìù –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH config..."
mkdir -p ~/.ssh
chmod 700 ~/.ssh

if [ ! -f ~/.ssh/config ]; then
    touch ~/.ssh/config
    chmod 600 ~/.ssh/config
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è GitLab
if grep -q "Host gitlab.com" ~/.ssh/config; then
    echo "‚ö†Ô∏è  –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è gitlab.com —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ ~/.ssh/config"
    read -p "–ó–∞–º–µ–Ω–∏—Ç—å? (y/n): " REPLACE_CONFIG
    if [ "$REPLACE_CONFIG" = "y" ] || [ "$REPLACE_CONFIG" = "Y" ]; then
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É
        sed -i.bak '/^Host gitlab.com/,/^$/d' ~/.ssh/config
    else
        echo "‚ÑπÔ∏è  –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞"
        exit 0
    fi
fi

# –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –¥–ª—è GitLab
cat >> ~/.ssh/config << EOF

Host gitlab.com
    HostName gitlab.com
    User git
    IdentityFile $KEY_FILE
    IdentitiesOnly yes
EOF

chmod 600 ~/.ssh/config
echo "‚úÖ SSH config –æ–±–Ω–æ–≤–ª–µ–Ω"

# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª—é—á–∞ –≤ GitLab
echo ""
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "üìã –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""
echo "1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –≤—ã—à–µ (–≤–µ—Å—å —Ç–µ–∫—Å—Ç –º–µ–∂–¥—É –ª–∏–Ω–∏—è–º–∏)"
echo ""
echo "2. –û—Ç–∫—Ä–æ–π—Ç–µ GitLab: https://gitlab.com/-/profile/keys"
echo "   –ò–ª–∏: Settings ‚Üí SSH Keys"
echo ""
echo "3. –í—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á –≤ –ø–æ–ª–µ 'Key'"
echo ""
echo "4. –î–æ–±–∞–≤—å—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 'MacBook Pro')"
echo ""
echo "5. –ù–∞–∂–º–∏—Ç–µ 'Add key'"
echo ""
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""

# –ö–æ–ø–∏—Ä—É–µ–º –∫–ª—é—á –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
if command -v pbcopy >/dev/null 2>&1; then
    read -p "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞? (y/n): " COPY_CLIP
    if [ "$COPY_CLIP" = "y" ] || [ "$COPY_CLIP" = "Y" ]; then
        cat "${KEY_FILE}.pub" | pbcopy
        echo "‚úÖ –ö–ª—é—á —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!"
    fi
fi

echo ""
read -p "–ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª—é—á–∞ –≤ GitLab –Ω–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ GitLab..."
if ssh -T git@gitlab.com 2>&1 | grep -q "Welcome to GitLab"; then
    echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ GitLab —É—Å–ø–µ—à–Ω–æ!"
else
    echo "‚ö†Ô∏è  –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:"
    echo "   - –î–æ–±–∞–≤–ª–µ–Ω –ª–∏ –∫–ª—é—á –≤ GitLab"
    echo "   - –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–ª—é—á–∞"
    ssh -T git@gitlab.com 2>&1 || true
fi

echo ""
echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"

